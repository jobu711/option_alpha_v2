{% extends "base.html" %}

{% block title %}Settings - Option Alpha{% endblock %}

{% block content %}
<div class="settings-page">
    <div class="settings-header">
        <h1>Settings</h1>
        <p class="settings-subtitle">Configure scoring weights, filters, and AI backend.</p>
    </div>

    <!-- Success/Error message target -->
    <div id="settings-message"></div>

    <form hx-post="/settings" hx-target="#settings-message" hx-swap="innerHTML">
        <!-- Scoring Weights -->
        <section class="settings-section">
            <h2>Scoring Weights</h2>
            <p class="section-desc">Adjust the relative weight of each technical indicator in the composite score. Values should be between 0 and 1.</p>
            <div class="settings-grid">
                {% for key, value in weights.items() %}
                <div class="form-group">
                    <label for="weight_{{ key }}">{{ key | replace("_", " ") | title }}</label>
                    <input type="number" id="weight_{{ key }}" name="weight_{{ key }}"
                           value="{{ '%.2f'|format(value) }}" min="0" max="1" step="0.01"
                           class="form-input mono">
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Filters -->
        <section class="settings-section">
            <h2>Filters</h2>
            <p class="section-desc">Set minimum thresholds for ticker screening.</p>
            <div class="settings-grid">
                <div class="form-group">
                    <label for="min_composite_score">Min Composite Score</label>
                    <input type="number" id="min_composite_score" name="min_composite_score"
                           value="{{ '%.1f'|format(config.min_composite_score) }}" min="0" max="100" step="0.1"
                           class="form-input mono">
                </div>
                <div class="form-group">
                    <label for="min_price">Min Price ($)</label>
                    <input type="number" id="min_price" name="min_price"
                           value="{{ '%.2f'|format(config.min_price) }}" min="0" step="0.01"
                           class="form-input mono">
                </div>
                <div class="form-group">
                    <label for="min_avg_volume">Min Avg Volume</label>
                    <input type="number" id="min_avg_volume" name="min_avg_volume"
                           value="{{ config.min_avg_volume }}" min="0" step="1000"
                           class="form-input mono">
                </div>
            </div>
        </section>

        <!-- Options Parameters -->
        <section class="settings-section">
            <h2>Options Parameters</h2>
            <p class="section-desc">Configure options chain filtering and DTE range.</p>
            <div class="settings-grid">
                <div class="form-group">
                    <label for="dte_min">DTE Min (days)</label>
                    <input type="number" id="dte_min" name="dte_min"
                           value="{{ config.dte_min }}" min="1" step="1"
                           class="form-input mono">
                </div>
                <div class="form-group">
                    <label for="dte_max">DTE Max (days)</label>
                    <input type="number" id="dte_max" name="dte_max"
                           value="{{ config.dte_max }}" min="1" step="1"
                           class="form-input mono">
                </div>
                <div class="form-group">
                    <label for="min_open_interest">Min Open Interest</label>
                    <input type="number" id="min_open_interest" name="min_open_interest"
                           value="{{ config.min_open_interest }}" min="0" step="1"
                           class="form-input mono">
                </div>
                <div class="form-group">
                    <label for="max_bid_ask_spread_pct">Max Bid-Ask Spread (%)</label>
                    <input type="number" id="max_bid_ask_spread_pct" name="max_bid_ask_spread_pct"
                           value="{{ '%.2f'|format(config.max_bid_ask_spread_pct) }}" min="0" max="1" step="0.01"
                           class="form-input mono">
                </div>
                <div class="form-group">
                    <label for="min_option_volume">Min Option Volume</label>
                    <input type="number" id="min_option_volume" name="min_option_volume"
                           value="{{ config.min_option_volume }}" min="0" step="1"
                           class="form-input mono">
                </div>
            </div>
        </section>

        <!-- Data Fetch -->
        <section class="settings-section">
            <h2>Data Fetch</h2>
            <p class="section-desc">Configure data fetching behavior: batch sizes, concurrency, retries, and failure cache lifetime.</p>
            <div class="settings-grid">
                <div class="form-group">
                    <label for="fetch_batch_size">Batch Size</label>
                    <input type="number" id="fetch_batch_size" name="fetch_batch_size"
                           value="{{ config.fetch_batch_size }}" min="1" step="1"
                           class="form-input mono">
                </div>
                <div class="form-group">
                    <label for="fetch_max_workers">Max Workers</label>
                    <input type="number" id="fetch_max_workers" name="fetch_max_workers"
                           value="{{ config.fetch_max_workers }}" min="1" step="1"
                           class="form-input mono">
                </div>
                <div class="form-group">
                    <label for="fetch_max_retries">Max Retries</label>
                    <input type="number" id="fetch_max_retries" name="fetch_max_retries"
                           value="{{ config.fetch_max_retries }}" min="0" step="1"
                           class="form-input mono">
                </div>
                <div class="form-group">
                    <label for="failure_cache_ttl_hours">Failure Cache TTL (hours)</label>
                    <input type="number" id="failure_cache_ttl_hours" name="failure_cache_ttl_hours"
                           value="{{ config.failure_cache_ttl_hours }}" min="1" step="1"
                           class="form-input mono">
                </div>
            </div>
            <div style="margin-top: 1rem;">
                <button type="button" class="btn btn-secondary"
                        hx-post="/clear-failure-cache"
                        hx-target="body"
                        hx-confirm="Clear all cached fetch failures? Tickers will be retried on next scan.">
                    Clear Failure Cache
                </button>
            </div>
        </section>

        <!-- AI Configuration -->
        <section class="settings-section">
            <h2>AI Configuration</h2>
            <p class="section-desc">Choose AI backend and configure model parameters.</p>
            <div class="settings-grid">
                <div class="form-group form-group-wide">
                    <label>AI Backend</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="ai_backend" value="ollama"
                                   {% if config.ai_backend == "ollama" %}checked{% endif %}>
                            <span>Ollama (Local)</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="ai_backend" value="claude"
                                   {% if config.ai_backend == "claude" %}checked{% endif %}>
                            <span>Claude (API)</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ollama_model">Ollama Model</label>
                    <input type="text" id="ollama_model" name="ollama_model"
                           value="{{ config.ollama_model }}"
                           class="form-input mono">
                </div>
                <div class="form-group">
                    <label for="claude_api_key">Claude API Key</label>
                    <input type="password" id="claude_api_key" name="claude_api_key"
                           value="" placeholder="{{ masked_claude_key }}"
                           class="form-input mono">
                    <span class="form-hint">Leave blank to keep current key.</span>
                </div>
            </div>
        </section>

        <!-- FRED API -->
        <section class="settings-section">
            <h2>FRED API</h2>
            <p class="section-desc">Federal Reserve Economic Data API key for risk-free rate lookups.</p>
            <div class="settings-grid">
                <div class="form-group">
                    <label for="fred_api_key">FRED API Key</label>
                    <input type="password" id="fred_api_key" name="fred_api_key"
                           value="" placeholder="{{ masked_fred_key }}"
                           class="form-input mono">
                    <span class="form-hint">Leave blank to keep current key.</span>
                </div>
            </div>
        </section>

        <!-- Actions -->
        <div class="settings-actions">
            <button type="submit" class="btn btn-primary">Save Settings</button>
            <button type="button" class="btn btn-secondary"
                    hx-post="/settings/reset"
                    hx-target="body"
                    hx-confirm="Reset all settings to defaults? This cannot be undone.">
                Reset to Defaults
            </button>
        </div>
    </form>

    <!-- Watchlist Management (outside the main settings form) -->
    <section class="settings-section" x-data="watchlistManager()" x-init="init()">
        <h2>Watchlists</h2>
        <p class="section-desc">Create and manage named ticker watchlists. The active watchlist's tickers are included in every scan.</p>

        <!-- Existing Watchlists -->
        <div class="watchlist-list" id="watchlist-list">
            <template x-if="Object.keys(watchlists).length === 0">
                <p style="color: var(--text-muted); font-size: 13px; padding: 10px 0;">No watchlists yet. Create one below.</p>
            </template>
            <template x-for="(tickers, name) in watchlists" :key="name">
                <div class="watchlist-item">
                    <div>
                        <span class="watchlist-name" x-text="name"></span>
                        <span class="watchlist-count" x-text="tickers.length + ' tickers'"></span>
                        <template x-if="activeWatchlist === name">
                            <span class="watchlist-badge-active">ACTIVE</span>
                        </template>
                    </div>
                    <div class="watchlist-actions">
                        <template x-if="activeWatchlist !== name">
                            <button class="btn btn-small" @click="activate(name)">Set Active</button>
                        </template>
                        <template x-if="activeWatchlist === name">
                            <button class="btn btn-small" @click="deactivate()">Deactivate</button>
                        </template>
                        <button class="btn btn-small" @click="startEdit(name, tickers)">Edit</button>
                        <button class="btn btn-small btn-danger" @click="remove(name)">Delete</button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Create / Edit Form -->
        <div class="watchlist-form">
            <h3 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;" x-text="editing ? 'Edit Watchlist' : 'Create Watchlist'"></h3>
            <div class="settings-grid" style="grid-template-columns: 1fr 2fr;">
                <div class="form-group">
                    <label for="wl-name">Name (kebab-case)</label>
                    <input type="text" id="wl-name" class="form-input mono"
                           x-model="formName" placeholder="my-watchlist"
                           :disabled="editing">
                </div>
                <div class="form-group">
                    <label for="wl-tickers">Tickers (comma or space separated)</label>
                    <textarea id="wl-tickers" x-model="formTickers"
                              placeholder="AAPL, MSFT, GOOG, TSLA"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-primary" @click="save()" x-text="editing ? 'Update' : 'Create'"></button>
                <template x-if="editing">
                    <button class="btn btn-secondary" @click="cancelEdit()">Cancel</button>
                </template>
            </div>
            <div x-show="message" :class="'settings-msg ' + (messageType === 'error' ? 'settings-msg-error' : 'settings-msg-success')"
                 x-text="message" style="margin-top: 8px;"></div>
        </div>
    </section>

    <!-- Universe Refresh -->
    <section class="settings-section">
        <h2>Universe Data</h2>
        <p class="section-desc">Refresh the ticker universe from SEC EDGAR. This re-downloads all tickers and validates optionability.</p>
        <div>
            <button type="button" class="btn btn-secondary" id="refresh-btn"
                    onclick="refreshUniverse()">
                Refresh Universe
            </button>
            <div id="refresh-status" class="refresh-status"></div>
        </div>
    </section>

    <script>
    function watchlistManager() {
        return {
            watchlists: {},
            activeWatchlist: null,
            formName: '',
            formTickers: '',
            editing: false,
            message: '',
            messageType: '',
            async init() {
                await this.loadWatchlists();
            },
            async loadWatchlists() {
                try {
                    const resp = await fetch('/api/watchlists');
                    const data = await resp.json();
                    this.watchlists = data.watchlists || {};
                    this.activeWatchlist = data.active_watchlist;
                } catch (e) {
                    console.error('Failed to load watchlists:', e);
                }
            },
            startEdit(name, tickers) {
                this.editing = true;
                this.formName = name;
                this.formTickers = tickers.join(', ');
                this.message = '';
            },
            cancelEdit() {
                this.editing = false;
                this.formName = '';
                this.formTickers = '';
                this.message = '';
            },
            async save() {
                const name = this.formName.trim();
                const tickers = this.formTickers
                    .split(/[,\s]+/)
                    .map(t => t.trim().toUpperCase())
                    .filter(t => t.length > 0);
                if (!name) {
                    this.message = 'Name is required';
                    this.messageType = 'error';
                    return;
                }
                if (tickers.length === 0) {
                    this.message = 'At least one ticker is required';
                    this.messageType = 'error';
                    return;
                }
                try {
                    const resp = await fetch('/api/watchlists', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, tickers }),
                    });
                    const data = await resp.json();
                    if (data.success) {
                        this.message = this.editing ? 'Watchlist updated' : 'Watchlist created';
                        this.messageType = 'success';
                        this.editing = false;
                        this.formName = '';
                        this.formTickers = '';
                        await this.loadWatchlists();
                    } else {
                        this.message = data.error || 'Failed to save';
                        this.messageType = 'error';
                    }
                } catch (e) {
                    this.message = 'Request failed';
                    this.messageType = 'error';
                }
            },
            async remove(name) {
                if (!confirm('Delete watchlist "' + name + '"?')) return;
                try {
                    await fetch('/api/watchlists/' + encodeURIComponent(name), { method: 'DELETE' });
                    await this.loadWatchlists();
                } catch (e) {
                    console.error('Failed to delete watchlist:', e);
                }
            },
            async activate(name) {
                try {
                    await fetch('/api/watchlists/' + encodeURIComponent(name) + '/activate', { method: 'POST' });
                    await this.loadWatchlists();
                } catch (e) {
                    console.error('Failed to activate watchlist:', e);
                }
            },
            async deactivate() {
                try {
                    await fetch('/api/watchlists/deactivate', { method: 'POST' });
                    await this.loadWatchlists();
                } catch (e) {
                    console.error('Failed to deactivate watchlist:', e);
                }
            },
        };
    }

    async function refreshUniverse() {
        const btn = document.getElementById('refresh-btn');
        const status = document.getElementById('refresh-status');
        btn.disabled = true;
        btn.textContent = 'Refreshing...';
        status.textContent = '';
        status.className = 'refresh-status';
        try {
            const resp = await fetch('/api/universe/refresh', { method: 'POST' });
            const data = await resp.json();
            if (data.success) {
                status.textContent = 'Refreshed: ' + data.ticker_count + ' tickers ('
                    + data.added + ' added, ' + data.removed + ' removed)';
                status.className = 'refresh-status success';
            } else {
                status.textContent = 'Refresh failed: ' + (data.error || 'Unknown error');
                status.className = 'refresh-status error';
            }
        } catch (e) {
            status.textContent = 'Request failed: ' + e.message;
            status.className = 'refresh-status error';
        } finally {
            btn.disabled = false;
            btn.textContent = 'Refresh Universe';
        }
    }
    </script>
</div>
{% endblock %}
