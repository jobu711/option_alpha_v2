{% extends "base.html" %}

{% block title %}Dashboard - Option Alpha{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- System Status Alerts -->
    {% if system_status and system_status.has_errors %}
    {% for check in system_status.errors %}
    <div class="alert alert-error">
        <strong>{{ check.message }}</strong>
        {% if check.detail %}<p>{{ check.detail }}</p>{% endif %}
    </div>
    {% endfor %}
    {% endif %}
    {% if system_status and system_status.has_warnings %}
    {% for check in system_status.warnings %}
    <div class="alert alert-warning">
        <strong>{{ check.message }}</strong>
        {% if check.detail %}<p>{{ check.detail }}</p>{% endif %}
    </div>
    {% endfor %}
    {% endif %}
    {% if last_scan_error %}
    <div class="alert alert-error">
        <strong>{{ last_scan_error }}</strong>
        <p>Check Settings or try again.</p>
    </div>
    {% endif %}

    <!-- Market Regime Header -->
    <section class="market-regime">
        <h2>Market Regime</h2>
        <div class="regime-indicators">
            <div class="indicator">
                <span class="indicator-label">VIX</span>
                {% if market.vix %}
                    <span class="indicator-value badge
                        {% if market.vix < 15 %}badge-low
                        {% elif market.vix < 25 %}badge-medium
                        {% else %}badge-high{% endif %}">
                        {{ "%.2f"|format(market.vix) }}
                    </span>
                {% else %}
                    <span class="indicator-value badge badge-na">N/A</span>
                {% endif %}
            </div>
            <div class="indicator">
                <span class="indicator-label">SPY</span>
                {% if market.spy_price %}
                    <span class="indicator-value">
                        ${{ "%.2f"|format(market.spy_price) }}
                        {% if market.spy_trend == "up" %}
                            <span class="trend-up">&#9650;</span>
                        {% elif market.spy_trend == "down" %}
                            <span class="trend-down">&#9660;</span>
                        {% else %}
                            <span class="trend-flat">&#9654;</span>
                        {% endif %}
                    </span>
                {% else %}
                    <span class="indicator-value">N/A</span>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Universe Controls -->
    <section class="universe-controls" x-data="universeControls()" x-init="init()">
        <h2>Universe</h2>
        <div class="universe-grid">
            <div class="universe-presets-row">
                <span class="universe-label">Presets:</span>
                <div class="chip-group">
                    <template x-for="preset in allPresets" :key="preset.id">
                        <button class="chip"
                                :class="{ 'chip-active': selectedPresets.includes(preset.id) }"
                                @click="togglePreset(preset.id)"
                                x-text="preset.label"></button>
                    </template>
                </div>
            </div>
            <div class="universe-sectors-row">
                <span class="universe-label">Sectors:</span>
                <div class="chip-group chip-group-wrap">
                    <template x-for="sector in allSectors" :key="sector">
                        <button class="chip chip-small"
                                :class="{ 'chip-active': selectedSectors.includes(sector) }"
                                @click="toggleSector(sector)"
                                x-text="sector"></button>
                    </template>
                </div>
            </div>
            <div class="universe-estimate">
                <span class="scan-estimate" id="scan-estimate">
                    ~<span x-text="filteredCount"></span> tickers, est. <span x-text="estimatedTime"></span>
                </span>
            </div>
        </div>
    </section>

    <script>
    function universeControls() {
        return {
            allPresets: [
                { id: 'sp500', label: 'S&P 500' },
                { id: 'midcap', label: 'Mid-Cap' },
                { id: 'smallcap', label: 'Small-Cap' },
                { id: 'etfs', label: 'ETFs' },
                { id: 'full', label: 'Full' },
            ],
            allSectors: [],
            selectedPresets: [],
            selectedSectors: [],
            filteredCount: 0,
            estimatedTime: '...',
            async init() {
                try {
                    const resp = await fetch('/api/universe/stats');
                    const data = await resp.json();
                    this.allSectors = data.available_sectors || [];
                    this.selectedPresets = data.presets || ['full'];
                    this.selectedSectors = data.sectors || [];
                    this.filteredCount = data.filtered_tickers || 0;
                    this.updateEstimate();
                } catch (e) {
                    console.error('Failed to load universe stats:', e);
                }
            },
            togglePreset(id) {
                if (id === 'full') {
                    this.selectedPresets = ['full'];
                } else {
                    this.selectedPresets = this.selectedPresets.filter(p => p !== 'full');
                    const idx = this.selectedPresets.indexOf(id);
                    if (idx >= 0) {
                        this.selectedPresets.splice(idx, 1);
                    } else {
                        this.selectedPresets.push(id);
                    }
                    if (this.selectedPresets.length === 0) {
                        this.selectedPresets = ['full'];
                    }
                }
                this.saveConfig();
            },
            toggleSector(sector) {
                const idx = this.selectedSectors.indexOf(sector);
                if (idx >= 0) {
                    this.selectedSectors.splice(idx, 1);
                } else {
                    this.selectedSectors.push(sector);
                }
                this.saveConfig();
            },
            async saveConfig() {
                try {
                    const resp = await fetch('/api/scan/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            presets: this.selectedPresets,
                            sectors: this.selectedSectors,
                        }),
                    });
                    const data = await resp.json();
                    this.filteredCount = data.filtered_tickers || 0;
                    this.updateEstimate();
                } catch (e) {
                    console.error('Failed to save scan config:', e);
                }
            },
            updateEstimate() {
                const seconds = this.filteredCount * 0.3;
                if (seconds < 60) {
                    this.estimatedTime = Math.round(seconds) + 's';
                } else {
                    this.estimatedTime = Math.round(seconds / 60) + ' min';
                }
            },
        };
    }
    </script>

    <!-- Data Freshness & Scan Controls -->
    <section class="scan-controls">
        <div class="freshness">
            {% if latest_scan %}
                <span class="freshness-label">Last scan:</span>
                <span class="freshness-time {% if stale %}stale{% endif %}">
                    {{ latest_scan.timestamp.strftime('%Y-%m-%d %H:%M UTC') }}
                    {% if stale %}
                        <span class="stale-warning">(stale - over 24h old)</span>
                    {% endif %}
                </span>
                <span class="freshness-stats">
                    {{ latest_scan.scores_computed }} scored |
                    {{ latest_scan.debates_completed }} debated |
                    {{ latest_scan.options_analyzed }} options
                    {% if failure_stats and failure_stats.count > 0 %}
                    | {{ failure_stats.count }} tickers skipped
                    {% endif %}
                </span>
            {% else %}
                <span class="freshness-label">No scan data yet &mdash; click 'Run Scan' to start</span>
            {% endif %}
        </div>

        <button class="btn btn-primary"
                hx-post="/scan"
                hx-target="#progress-area"
                hx-swap="innerHTML"
                {% if scan_running %}disabled{% endif %}>
            {% if scan_running %}Scan Running...{% else %}Run Scan{% endif %}
        </button>
    </section>

    <!-- Progress Display Area -->
    <div id="progress-area"></div>

    <!-- Candidates Table -->
    <section class="candidates-section">
        <h2>Ranked Candidates</h2>
        <div id="candidates-table"
             hx-get="/candidates"
             hx-trigger="load"
             hx-swap="innerHTML">
            <p class="loading">Loading candidates...</p>
        </div>
    </section>

    <!-- Ticker Detail Panel -->
    <section class="detail-section" id="detail-panel" style="display:none;">
    </section>
</div>
{% endblock %}
