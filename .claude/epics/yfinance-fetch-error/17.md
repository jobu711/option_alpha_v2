---
name: Add tests for failure cache, error classification, and fetcher
status: open
created: 2026-02-11T13:44:14Z
updated: 2026-02-11T13:44:14Z
github: https://github.com/jobu711/option_alpha_v2/issues/17
depends_on: [19, 14, 15, 16]
parallel: false
conflicts_with: []
---

# Task: Add tests for failure cache, error classification, and fetcher

## Description
Create a new test file with ~15-20 tests covering all new functionality: failure cache CRUD operations, TTL eviction, corruption handling, FetchErrorType classification, configurable fetcher params, orchestrator integration with mocked fetcher, and settings page fields.

## Acceptance Criteria
- [ ] Test file created at `tests/test_fetch_errors.py` (or similar)
- [ ] Tests for `load_failure_cache`: empty file, expired entries evicted, valid entries returned
- [ ] Tests for `record_failures`: new entries added, existing entries updated
- [ ] Tests for `clear_failure_cache`: file deleted, no error if file doesn't exist
- [ ] Tests for `get_failure_cache_stats`: correct counts and type breakdown
- [ ] Tests for corruption handling: corrupt JSON gracefully handled
- [ ] Tests for `FetchErrorType` classification in fetcher
- [ ] Tests for fetcher accepting configurable params
- [ ] Tests for orchestrator filtering known-failed tickers
- [ ] Tests for new settings fields round-trip (save/load)
- [ ] All 15-20 new tests pass
- [ ] All existing 547+ tests still pass

## Technical Details
- File: `tests/test_fetch_errors.py` (new file)
- Use mocking extensively — no live API calls
- Mock `datetime.utcnow()` for TTL tests
- Use `tmp_path` fixture for cache file I/O tests
- Follow patterns from existing test files (e.g., `tests/test_cache.py`, `tests/test_fetcher.py`)

## Dependencies
- [ ] #19 (failure cache functions)
- [ ] #14 (fetcher refactor)
- [ ] #15 (orchestrator integration)
- [ ] #16 (web UI updates)

## Effort Estimate
- Size: M
- Hours: 3-4
- Parallel: false (final task — tests all prior work)

## Definition of Done
- [ ] Code implemented
- [ ] All new tests passing
- [ ] All existing 547+ tests still pass
- [ ] Coverage for new code >90%
