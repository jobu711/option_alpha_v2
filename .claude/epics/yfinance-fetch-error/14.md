---
name: Refactor fetcher with throttling and configurable params
status: open
created: 2026-02-11T13:44:14Z
updated: 2026-02-11T13:44:14Z
github: https://github.com/jobu711/option_alpha_v2/issues/14
depends_on: [18]
parallel: true
conflicts_with: []
---

# Task: Refactor fetcher with throttling and configurable params

## Description
Refactor `fetcher.py` to accept settings-driven `batch_size`, `max_workers`, `max_retries`, and `retry_delays` parameters instead of hardcoded constants. Add inter-batch delay via `batch_idx` parameter in `_process_batch`. Classify errors by parsing yfinance exception messages using `FetchErrorType`.

## Acceptance Criteria
- [ ] `fetch_batch()` accepts `max_retries`, `retry_delays`, `batch_size`, `max_workers` as parameters
- [ ] `_process_batch` accepts `batch_idx` parameter and adds `time.sleep()` stagger between batches
- [ ] `_download_batch` classifies errors by parsing exception messages into FetchErrorType values
- [ ] Error classification logic: "delisted" → DELISTED, "401"/"rate" → RATE_LIMITED, "connection"/"timeout" → NETWORK, "insufficient" → INSUFFICIENT_DATA, else → UNKNOWN
- [ ] Default parameter values match current behavior (except workers: 4→2)
- [ ] All existing tests pass

## Technical Details
- File: `src/option_alpha/data/fetcher.py`
- Import `FetchErrorType` from `models.py` (depends on #18)
- Stagger formula: `time.sleep(batch_idx * 0.5)` or similar — simple fixed delay
- Keep existing function signatures backwards-compatible via default parameter values
- Return error classification alongside failed tickers for downstream consumption

## Dependencies
- [ ] #18 (FetchErrorType enum must exist)

## Effort Estimate
- Size: M
- Hours: 2-4
- Parallel: true (can run alongside #19 after #18 completes)

## Definition of Done
- [ ] Code implemented
- [ ] Tests written and passing
- [ ] Existing 547+ tests still pass
