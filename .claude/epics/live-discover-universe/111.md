---
name: Add discovery REST endpoints to universe routes
status: open
created: 2026-02-14T15:56:05Z
updated: 2026-02-14T15:59:30Z
github: https://github.com/jobu711/option_alpha_v2/issues/111
depends_on: [108, 110]
parallel: false
conflicts_with: [112]
---

# Task: Add discovery REST endpoints to universe routes

## Description
Add two endpoints to `web/universe_routes.py`: `POST /api/universe/refresh` to trigger discovery and `GET /api/universe/discovery-status` to check status. Uses the same concurrency guard pattern as `_scan_running`/`_debate_running` in `web/routes.py`.

## Acceptance Criteria
- [ ] `POST /api/universe/refresh` triggers `run_discovery()` as a BackgroundTask
- [ ] 409 returned if discovery is already running
- [ ] Module-level `_discovery_running` flag prevents concurrent runs
- [ ] Returns HTMX partial for `HX-Request`, JSON otherwise
- [ ] `GET /api/universe/discovery-status` returns `{running: bool, last_run: dict|null}`
- [ ] Flag correctly reset to False on completion (including error paths)

## Technical Details

### New module-level state
```python
_discovery_running = False
```

### POST /api/universe/refresh
```python
@router.post("/api/universe/refresh")
async def refresh_universe(request: Request, background_tasks: BackgroundTasks):
    global _discovery_running
    if _discovery_running:
        raise HTTPException(409, "Discovery already running")
    _discovery_running = True
    # Run discovery in background, reset flag on completion
    background_tasks.add(run_discovery_task)
    # Return status message (HTMX partial or JSON)
```

### GET /api/universe/discovery-status
```python
@router.get("/api/universe/discovery-status")
async def discovery_status(request: Request):
    # Return {running, last_run} from get_last_discovery_run()
```

### Imports needed
```python
from fastapi import BackgroundTasks
from option_alpha.data.discovery import run_discovery, get_last_discovery_run
from option_alpha.config import get_settings
```

### Files affected
- `src/option_alpha/web/universe_routes.py` (MODIFY â€” ~40 lines added)

## Dependencies
- [ ] Task 108 (migration/config)
- [ ] Task 110 (discovery engine must exist)

## Effort Estimate
- Size: S
- Hours: 1.5
- Parallel: false (depends on 108, 110)

## Definition of Done
- [ ] Code implemented
- [ ] Endpoints respond correctly (200 on success, 409 on concurrent)
- [ ] HTMX and JSON response modes both work
- [ ] `_discovery_running` flag always resets (even on errors)
