---
name: Add discovery settings and database migration
status: open
created: 2026-02-14T15:56:05Z
updated: 2026-02-14T15:59:30Z
github: https://github.com/jobu711/option_alpha_v2/issues/108
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Add discovery settings and database migration

## Description
Add 5 discovery-related settings to `config.py` and create the `005_discovery.sql` migration that adds `discovery_runs` and `discovery_failures` tables plus the "Auto-Discovered" preset tag. This is the foundation that all other discovery tasks depend on.

## Acceptance Criteria
- [ ] 5 new settings added to `Settings` class in `config.py` after `min_avg_volume` (line 51)
- [ ] `005_discovery.sql` created in `persistence/migrations/`
- [ ] `discovery_runs` table has columns: id, started_at, completed_at, cboe_symbols_fetched, new_tickers_added, stale_tickers_deactivated, status, error_message
- [ ] `discovery_failures` table has columns: symbol (PK), reason, failed_at with index on failed_at
- [ ] "Auto-Discovered" tag inserted via INSERT OR IGNORE into `universe_tags`
- [ ] Migration applies cleanly via `initialize_db()`

## Technical Details

### config.py changes (after line 51)
```python
# --- Universe discovery ---
cboe_optionable_url: str = "https://www.cboe.com/us/options/symboldir/equity_index_options/?download=csv"
universe_refresh_interval_days: int = 7
discovery_batch_size: int = 100
stale_ticker_threshold_days: int = 90
failure_cache_ttl_hours: int = 24
```

These align with keys already in `config.json` (`universe_refresh_interval_days`, `failure_cache_ttl_hours`).

### 005_discovery.sql
```sql
CREATE TABLE IF NOT EXISTS discovery_runs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    started_at TEXT NOT NULL DEFAULT (datetime('now')),
    completed_at TEXT,
    cboe_symbols_fetched INTEGER DEFAULT 0,
    new_tickers_added INTEGER DEFAULT 0,
    stale_tickers_deactivated INTEGER DEFAULT 0,
    status TEXT NOT NULL DEFAULT 'running',
    error_message TEXT
);

CREATE TABLE IF NOT EXISTS discovery_failures (
    symbol TEXT PRIMARY KEY,
    reason TEXT,
    failed_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_discovery_failures_failed_at ON discovery_failures(failed_at);

INSERT OR IGNORE INTO universe_tags (name, slug, is_preset, is_active)
VALUES ('Auto-Discovered', 'auto-discovered', 1, 1);
```

### Files affected
- `src/option_alpha/config.py` (MODIFY)
- `src/option_alpha/persistence/migrations/005_discovery.sql` (CREATE)

## Dependencies
- [ ] None â€” this is the foundation task

## Effort Estimate
- Size: S
- Hours: 1
- Parallel: false (blocks tasks 110, 111, 113)

## Definition of Done
- [ ] Code implemented
- [ ] Migration applies without errors on existing database
- [ ] Settings load correctly with defaults
- [ ] `config.json` keys (`universe_refresh_interval_days`, `failure_cache_ttl_hours`) map to new settings
