---
name: Fix last_scanned_at in orchestrator persist phase
status: open
created: 2026-02-14T15:56:05Z
updated: 2026-02-14T15:59:30Z
github: https://github.com/jobu711/option_alpha_v2/issues/109
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Fix last_scanned_at in orchestrator persist phase

## Description
Add a batch UPDATE to `_phase_persist()` in the orchestrator that sets `last_scanned_at = datetime('now')` for all successfully scored tickers. Currently this column is never written to, making the "Last Scanned" UI column and stale detection non-functional.

## Acceptance Criteria
- [ ] After `save_ticker_scores()` in `_phase_persist()`, a batch UPDATE sets `last_scanned_at` for all scored symbols
- [ ] Single UPDATE statement with `IN (...)` clause (no N+1 queries)
- [ ] Only tickers that were successfully scored are updated
- [ ] Existing tests still pass

## Technical Details

### orchestrator.py change (after line 409, inside `_phase_persist()`)
```python
scored_symbols = [ts.symbol for ts in ticker_scores]
if scored_symbols:
    placeholders = ",".join("?" for _ in scored_symbols)
    conn.execute(
        f"UPDATE universe_tickers SET last_scanned_at = datetime('now') "
        f"WHERE symbol IN ({placeholders})",
        scored_symbols,
    )
    conn.commit()
```

Insert after `save_ticker_scores(conn, scan_db_id, ticker_scores)` (line 409) and before `if debate_results:` (line 411). The `conn` is already open and the commit is safe here since `save_ticker_scores` has already committed its work.

### Files affected
- `src/option_alpha/pipeline/orchestrator.py` (MODIFY — ~7 lines added)

## Dependencies
- [ ] None — independent of discovery settings/migration

## Effort Estimate
- Size: XS
- Hours: 0.5
- Parallel: true (independent of all other tasks)

## Definition of Done
- [ ] Code implemented
- [ ] Existing pipeline tests pass
- [ ] After a scan, `last_scanned_at` is non-NULL for scored tickers
