---
name: Create discovery test suite
status: open
created: 2026-02-14T15:56:05Z
updated: 2026-02-14T15:59:30Z
github: https://github.com/jobu711/option_alpha_v2/issues/113
depends_on: [108, 109, 110]
parallel: false
conflicts_with: []
---

# Task: Create discovery test suite

## Description
Create `tests/test_discovery.py` with 14+ test cases covering the full discovery engine, failure caching, stale detection, readiness checks, and the `last_scanned_at` orchestrator fix. All external calls (httpx, yfinance) are mocked. Uses in-memory SQLite with migrations applied.

## Acceptance Criteria
- [ ] `tests/test_discovery.py` created with 14+ test cases
- [ ] All tests use mocked externals (no real network calls)
- [ ] In-memory SQLite with full migration chain applied
- [ ] Tests cover: CBOE parsing, yfinance validation, failure cache, stale detection, readiness, end-to-end, orchestrator fix

## Technical Details

### Test cases
1. `test_fetch_cboe_parses_symbols` — valid CSV extracts correct symbols
2. `test_fetch_cboe_filters_non_equity` — `$SPX`, `SPAK+`, numeric symbols skipped
3. `test_validate_filters_by_price_volume` — below-threshold tickers rejected
4. `test_failure_cache_within_ttl` — cached failures are skipped
5. `test_failure_cache_expired` — old failures are re-validated
6. `test_detect_stale_null_scanned` — old NULL `last_scanned_at` flagged
7. `test_detect_stale_old_scanned` — old timestamp flagged
8. `test_detect_stale_grace_period` — recently created NULL tickers NOT flagged
9. `test_should_run_never_run` — True when no completed runs
10. `test_should_run_overdue` — True when last run > interval
11. `test_should_run_recent` — False when last run < interval
12. `test_run_discovery_end_to_end` — full pipeline with mocked externals
13. `test_run_discovery_deduplicates` — existing tickers not re-added
14. `test_run_discovery_tags_auto_discovered` — new tickers get correct tag
15. `test_last_scanned_at_updated` — orchestrator persist phase updates column

### Mocking strategy
- `httpx.get` → return mock Response with CSV text body
- `yf.download` → return pre-built DataFrame with Close/Volume columns
- In-memory SQLite: `sqlite3.connect(":memory:")` with all migrations applied

### Files affected
- `tests/test_discovery.py` (CREATE — ~200 lines)

## Dependencies
- [ ] Task 108 (migration must exist for DB setup)
- [ ] Task 109 (orchestrator fix for `last_scanned_at` test)
- [ ] Task 110 (discovery module must exist)

## Effort Estimate
- Size: M
- Hours: 3
- Parallel: false (depends on implementation tasks)

## Definition of Done
- [ ] All 14+ tests pass
- [ ] No external network calls made during tests
- [ ] `pytest tests/test_discovery.py -v` runs cleanly
