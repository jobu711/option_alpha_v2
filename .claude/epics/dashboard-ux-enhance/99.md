---
name: Add subset scanning support
status: open
created: 2026-02-14T13:19:45Z
updated: 2026-02-14T13:26:09Z
github: https://github.com/jobu711/option_alpha_v2/issues/99
depends_on: [102]
parallel: false
conflicts_with: []
---

# Task: Add subset scanning support

## Description
Enable users to scan a subset of their universe instead of always scanning all active tickers. Support two entry points: (1) a "Scan by Tag" dropdown on the dashboard next to "Run Scan", and (2) "Scan Selected"/"Scan This Tag" buttons on the universe page. The backend accepts an optional ticker list, passing it through the existing pipeline.

## Acceptance Criteria
- [ ] `POST /scan` accepts optional JSON body: `{symbols: ["AAPL", "MSFT", ...]}` and/or `{tag: "tech-stocks"}`
- [ ] When `symbols` provided, only those tickers are scanned (not the full active universe)
- [ ] When `tag` provided, resolve to symbols server-side via `get_tickers_by_tag()` and scan only those
- [ ] When neither provided, scan all active tickers (backwards-compatible)
- [ ] Orchestrator `run_scan()` accepts `ticker_subset: list[str] | None` parameter
- [ ] Dashboard shows a dropdown/split button: "Scan All" (default) and "Scan by Tag..." (shows tag list)
- [ ] Universe page shows "Scan Selected (N)" button when tickers are checked
- [ ] Universe page shows "Scan This Tag" button when a tag filter is active
- [ ] Progress display shows "Scanning N tickers" to clarify scope
- [ ] Results merge into the existing candidates table (update existing rows, add new ones)
- [ ] Subset scan results are persisted to the same `scan_runs` / `ticker_scores` tables

## Technical Details

**Backend changes:**

- `src/option_alpha/pipeline/orchestrator.py`:
  - Change `run_scan()` signature: `async def run_scan(self, ticker_subset: list[str] | None = None, on_progress: ProgressCallback | None = None)`
  - In `_phase_data_fetch()` (around line 198): `universe = ticker_subset if ticker_subset else get_active_universe(conn)`
  - Store subset on instance for progress messaging: `self._ticker_count = len(universe)`

- `src/option_alpha/web/routes.py`:
  - Update `POST /scan` to parse optional JSON body:
    ```python
    body = await request.json() if request.headers.get("content-type") == "application/json" else {}
    symbols = body.get("symbols")
    tag = body.get("tag")
    if tag:
        conn = initialize_db(settings.db_path)
        symbols = get_tickers_by_tag(conn, tag)
        conn.close()
    ```
  - Pass `symbols` to `_run_scan_task(settings, ticker_subset=symbols)`
  - Update `_run_scan_task()` to accept and forward `ticker_subset`

- `src/option_alpha/pipeline/progress.py`:
  - Add `ticker_count: int = 0` to `ScanProgress` model for display

**Frontend changes:**

- `src/option_alpha/web/templates/dashboard.html`:
  - Replace simple "Run Scan" button with a split button / dropdown:
    ```html
    <div class="scan-controls" x-data="{showTags: false}">
      <button hx-post="/scan" hx-target="#progress-area">Scan All (N)</button>
      <button @click="showTags = !showTags">▼</button>
      <div x-show="showTags" class="scan-tag-dropdown">
        {% for tag in tags %}
        <button hx-post="/scan" hx-vals='{"tag": "{{ tag.slug }}"}' hx-target="#progress-area">
          {{ tag.name }} ({{ tag.ticker_count }})
        </button>
        {% endfor %}
      </div>
    </div>
    ```
  - Pass `tags` list to dashboard template context in `routes.py`

- `src/option_alpha/web/templates/universe/universe.html`:
  - Add "Scan Selected (N)" button near bulk action buttons (visible when checkboxes checked)
  - Add "Scan This Tag" button (visible when a tag filter is active)
  - Use vanilla JS to collect checked symbols and POST to `/scan` with JSON body

**Key considerations:**
- The scan lock (`_scan_running`) works the same for subset scans — can't run concurrent scans
- Debate guard still checks symbols against latest scan results
- Results use DELETE-then-INSERT per scan_run, so subset scans create a new scan_run with only subset results; the dashboard should show the most recent scan_run's results regardless

## Dependencies
- [ ] Task 2 (ticker count display) — subset scan UI references ticker counts

## Effort Estimate
- Size: M
- Parallel: false (depends on Task 2)
