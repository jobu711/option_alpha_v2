---
name: Update and add tests for all changed logic
status: open
created: 2026-02-11T22:04:49Z
updated: 2026-02-11T22:20:13Z
github: https://github.com/jobu711/option_alpha_v2/issues/47
depends_on: [42, 44, 46, 48, 43, 45]
parallel: false
conflicts_with: []
---

# Task: Update and add tests for all changed logic

## Description
Comprehensive test update covering all changes from Tasks 1-6. Update existing tests that break due to changed defaults/logic, and add new tests validating the fixed behavior. This is the final gating task before the epic can be marked complete.

## Acceptance Criteria
- [ ] All 745+ existing tests pass (fix any broken by Tasks 1-6 changes)
- [ ] New tests for `sma_direction()` covering all 3 data tiers (< 50, 50-199, >= 200 bars)
- [ ] New tests for `determine_direction()` covering RSI-only fallback logic
- [ ] New tests validating `data_fetch_period` config setting wiring
- [ ] New tests for direction threshold config (`direction_rsi_strong_bullish/bearish`)
- [ ] Updated AI tests reflecting new risk agent prompt text and fallback markers
- [ ] Test count increases by at least 10 new test cases
- [ ] `pytest tests/ --cov=option_alpha` shows no coverage decrease

## Technical Details
- **tests/test_scoring.py**: Add tests for tiered `sma_direction()`:
  - 40-bar DataFrame → "neutral"
  - 100-bar clearly-uptrending DataFrame → "bullish" (SMA20 > SMA50 fallback)
  - 200-bar clearly-downtrending DataFrame → "bearish" (full SMA20/50/200)
  - 75-bar mixed signals → "neutral"
- **tests/test_scoring.py**: Add tests for relaxed `determine_direction()`:
  - RSI=65, SMA neutral → BULLISH (RSI-only)
  - RSI=35, SMA neutral → BEARISH (RSI-only)
  - RSI=52, SMA neutral → NEUTRAL (not decisive enough)
  - RSI=70, SMA bullish → BULLISH (both agree)
- **tests/test_config.py**: Verify `data_fetch_period`, `direction_rsi_strong_bullish`, `direction_rsi_strong_bearish` defaults
- **tests/test_ai.py**: Update any assertions on `RISK_SYSTEM_PROMPT` text, fallback response format
- **tests/test_pipeline.py**: Verify `data_fetch_period` is passed through orchestrator
- Use synthetic DataFrames with `pd.DataFrame({"Open": ..., "High": ..., "Low": ..., "Close": ..., "Volume": ...})` to create known-trend data

## Dependencies
- [ ] All Tasks 1-6 must be complete

## Effort Estimate
- Size: M
- Hours: 3-4
- Parallel: false (depends on all other tasks)

## Definition of Done
- [ ] `pytest tests/` passes with 0 failures
- [ ] `pytest tests/ --cov=option_alpha` shows no coverage regression
- [ ] At least 10 new test cases added
- [ ] All direction classification edge cases covered
