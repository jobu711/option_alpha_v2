---
name: Rewrite agents.py with simplified retry
status: open
created: 2026-02-13T14:33:53Z
updated: 2026-02-13T14:36:49Z
github: https://github.com/jobu711/option_alpha_v2/issues/80
depends_on: [79]
parallel: false
conflicts_with: [79]
---

# Task: Rewrite agents.py with simplified retry

## Description

Rewrite `src/option_alpha/ai/agents.py` to use a simplified retry mechanism (1 attempt + 1 retry) and catch SDK-specific exceptions instead of httpx exceptions. Keep all system prompts, agent function signatures, and fallback logic unchanged.

## Acceptance Criteria

- [ ] `_run_agent_with_retry()` replaced with simpler `_call_with_retry()` — max 2 attempts total
- [ ] Parse/validation errors: retry once immediately with corrective hint
- [ ] Network errors (SDK exceptions): retry once after 2s delay
- [ ] Second failure: raise to let agent function return context-aware fallback
- [ ] System prompts (BULL/BEAR/RISK_SYSTEM_PROMPT) preserved verbatim
- [ ] `run_bull_agent()`, `run_bear_agent()`, `run_risk_agent()` — same signatures and behavior
- [ ] `_fallback_agent_response()` and `_fallback_thesis()` preserved verbatim
- [ ] No httpx imports — catch `anthropic` and `ollama` SDK exceptions instead
- [ ] `ErrorCategory` classification uses SDK exception types

## Technical Details

### New retry wrapper
```python
async def _call_with_retry(
    client: LLMClient,
    messages: list[dict[str, str]],
    response_model: type[T],
    role: str,
    ticker: str = "",
) -> T:
    """Call LLM with one retry. Parse errors retry immediately, network errors retry after 2s."""
    try:
        return await client.complete(messages, response_model=response_model)
    except (json.JSONDecodeError, ValidationError) as e:
        # Retry once with corrective hint
        messages.append({"role": "user", "content": f"Fix validation: {e}"})
        return await client.complete(messages, response_model=response_model)
    except Exception as e:
        # Network/unknown — retry once after short delay
        await asyncio.sleep(2.0)
        return await client.complete(messages, response_model=response_model)
```

### SDK exceptions to catch
- `anthropic.APIError`, `anthropic.APITimeoutError`, `anthropic.AuthenticationError`
- `ollama.ResponseError`, connection errors
- Both SDKs raise standard Python exceptions for network issues

### Things to preserve exactly
- All 3 system prompt strings
- `_fallback_agent_response(role, ticker_score)` — same context-aware fallback logic
- `_fallback_thesis(symbol, ticker_score)` — same context-aware fallback logic
- Agent function signatures: `run_bull_agent(context, client, retry_delays, ticker_score)`
- Note: `retry_delays` parameter kept for interface compatibility but ignored (fixed 2s delay)

### Files affected
- `src/option_alpha/ai/agents.py` — full rewrite

## Dependencies

- [ ] Task 79 (clients.py rewritten — agents call `client.complete()`)

## Effort Estimate

- Size: M
- Hours: 2
- Parallel: false (depends on clients.py)

## Definition of Done

- [ ] agents.py rewritten with simplified retry
- [ ] All agent function signatures preserved
- [ ] All system prompts preserved
- [ ] All fallback functions preserved
- [ ] No httpx imports
