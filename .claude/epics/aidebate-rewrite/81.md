---
name: Rewrite debate.py with simplified time budget
status: open
created: 2026-02-13T14:33:53Z
updated: 2026-02-13T14:36:49Z
github: https://github.com/jobu711/option_alpha_v2/issues/81
depends_on: [80]
parallel: false
conflicts_with: [80]
---

# Task: Rewrite debate.py with simplified time budget

## Description

Rewrite `src/option_alpha/ai/debate.py` to use a simple equal time budget (per_ticker_timeout / 3 per agent) instead of the current complex dynamic allocation (40%/50%/remaining). Keep the same `DebateManager` class interface, semaphore concurrency, phase timeout, and progress callbacks.

## Acceptance Criteria

- [ ] `DebateManager.__init__(client)` — unchanged
- [ ] `run_debate()` — each agent gets `per_ticker_timeout / 3` timeout (equal split)
- [ ] `run_debates()` — same semaphore-gated concurrency, same progress callback signature
- [ ] Deterministic ordering preserved (sort results by `composite_score` descending)
- [ ] `_build_risk_response()` preserved
- [ ] `_fallback_debate_result()` preserved
- [ ] `ProgressCallback` type alias preserved
- [ ] Phase-level timeout (`ai_debate_phase_timeout`) preserved
- [ ] Phase summary logging preserved (completed/total/failures/elapsed)

## Technical Details

### Simplified run_debate()
```python
async def run_debate(self, ticker_score, options_rec=None, per_ticker_timeout=None, retry_delays=None):
    context = build_context(ticker_score, options_rec)
    agent_timeout = per_ticker_timeout / 3 if per_ticker_timeout else None

    # Step 1: Bull
    try:
        bull = await asyncio.wait_for(run_bull_agent(...), timeout=agent_timeout)
    except asyncio.TimeoutError:
        return _fallback_debate_result(ticker_score)

    # Step 2: Bear
    try:
        bear = await asyncio.wait_for(run_bear_agent(...), timeout=agent_timeout)
    except asyncio.TimeoutError:
        return _fallback_debate_result(ticker_score)

    # Step 3: Risk
    try:
        thesis = await asyncio.wait_for(run_risk_agent(...), timeout=agent_timeout)
    except asyncio.TimeoutError:
        return _fallback_debate_result(ticker_score)

    return DebateResult(symbol=..., bull=bull, bear=bear, risk=_build_risk_response(thesis), final_thesis=thesis)
```

### run_debates() — mostly same structure
- `get_effective_ai_settings()` for backend-aware defaults
- `asyncio.Semaphore(concurrency)` for gating
- `asyncio.wait_for(asyncio.gather(...), timeout=phase_timeout)` for phase limit
- Results sorted by `composite_score` descending
- Progress callback: `(completed, total, symbol)`

### Key simplification
- Remove budget tracking variables (`budget_total`, `budget_start`, `remaining`)
- Remove dynamic percentage allocation (40%/50%/remaining)
- Remove "insufficient budget" early-abort checks
- Each agent gets a clean, equal timeout

### Files affected
- `src/option_alpha/ai/debate.py` — full rewrite

## Dependencies

- [ ] Task 80 (agents.py rewritten — debate calls agent functions)

## Effort Estimate

- Size: M
- Hours: 2
- Parallel: false (depends on agents.py)

## Definition of Done

- [ ] debate.py rewritten with simplified time budget
- [ ] DebateManager interface preserved
- [ ] Concurrency and phase timeout preserved
- [ ] Progress callbacks preserved
