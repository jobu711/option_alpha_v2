---
name: Add APScheduler for weekly refresh
status: open
created: 2026-02-12T13:08:06Z
updated: 2026-02-12T13:15:04Z
github: https://github.com/jobu711/option_alpha_v2/issues/58
depends_on: [60]
parallel: true
conflicts_with: []
---

# Task: Add APScheduler for weekly refresh

## Description
Add APScheduler as a dependency and integrate a `BackgroundScheduler` into the FastAPI lifespan to run universe refresh weekly on the configured day. The scheduler should start on app startup and shut down cleanly on app teardown.

## Acceptance Criteria
- [ ] `apscheduler` added to `pyproject.toml` dependencies
- [ ] `BackgroundScheduler` created and started in `web/app.py` lifespan `async with` block
- [ ] Weekly job scheduled using `CronTrigger` with day_of_week from `settings.universe_refresh_schedule`
- [ ] Job runs at a reasonable time (e.g., Saturday 2:00 AM UTC)
- [ ] Scheduler shuts down cleanly in the lifespan teardown (after `yield`)
- [ ] Scheduled job calls `refresh_universe(regenerate=False)` (validate-only mode for weekly maintenance)
- [ ] Scheduler respects `universe_refresh_interval_days` setting (skips if last refresh was recent via `should_refresh()`)
- [ ] Startup log message confirms scheduler is active with next run time

## Technical Details
- File: `pyproject.toml` — add `apscheduler>=3.10` to core dependencies
- File: `src/option_alpha/web/app.py` — modify `lifespan()` context manager
- Use `BackgroundScheduler` (not `AsyncIOScheduler`) since `refresh_universe()` is async — wrap the call with `asyncio.run()` or use the async scheduler if available
- Actually, since we're in an async context, prefer `AsyncIOScheduler` from APScheduler and `await refresh_universe()` directly
- The job function should: check `should_refresh()` first, then call `refresh_universe(regenerate=False)`, then log results
- Handle the case where the app starts and a refresh is overdue — run immediately on startup if `should_refresh()` returns True

## Dependencies
- [ ] Task 60 (refresh function with OI validation must work)
- [ ] APScheduler package installed

## Effort Estimate
- Size: S
- Hours: 3
- Parallel: true (can run alongside tasks 3 and 4 after task 2)

## Definition of Done
- [ ] APScheduler dependency added
- [ ] Scheduler starts/stops with FastAPI app
- [ ] Weekly job configured and fires correctly
- [ ] Startup log confirms schedule
