---
name: Implement atomic writes and ETF preservation
status: open
created: 2026-02-12T13:08:06Z
updated: 2026-02-12T13:15:04Z
github: https://github.com/jobu711/option_alpha_v2/issues/61
depends_on: [60]
parallel: false
conflicts_with: [60]
---

# Task: Implement atomic writes and ETF preservation

## Description
Make `universe_data.json` writes atomic (write to `.tmp`, backup to `.bak`, rename) so a failed refresh never corrupts the live file. Separate ETF entries before stock regeneration and merge them back after, ensuring ETFs survive the process unchanged. Add universe size warnings to logs and `universe_meta.json`.

## Acceptance Criteria
- [ ] `_do_refresh()` writes to `universe_data.json.tmp` first, then renames to `universe_data.json`
- [ ] Before overwriting, current `universe_data.json` is copied to `universe_data.json.bak`
- [ ] If write or rename fails, previous `universe_data.json` remains intact
- [ ] ETF entries from current universe are extracted before regeneration and merged back into final output
- [ ] ETF entries are validated for optionability (have expiration dates) but NOT filtered by OI threshold
- [ ] If stock count < 500 after filtering, a warning is logged and recorded in `universe_meta.json`
- [ ] If stock count > 1500 after filtering, a warning is logged and recorded in `universe_meta.json`
- [ ] `universe_meta.json` includes `stock_count`, `etf_count`, and optional `size_warning` field

## Technical Details
- File: `src/option_alpha/data/universe_refresh.py`
- Atomic write pattern: `Path.write_text()` to `.tmp` path, then `shutil.copy2()` current to `.bak`, then `Path.rename()` `.tmp` to live
- ETF preservation: before regeneration, load current universe, filter `asset_type == "etf"` entries, set aside; after stock regeneration + OI filtering + enrichment, concatenate ETFs back and sort by symbol
- Size warnings: add `size_warning` key to meta dict (null if within range, string message if outside)
- Update `universe_meta.json` to include `stock_count` and `etf_count` separately

## Dependencies
- [ ] Task 60 (OI validation must be in place)

## Effort Estimate
- Size: S
- Hours: 3
- Parallel: false (modifies same file as task 2)

## Definition of Done
- [ ] Atomic write pattern implemented
- [ ] ETF preservation verified
- [ ] Size warnings logged and recorded
- [ ] Previous universe recoverable from `.bak` file
