---
name: SQLite persistence layer
status: open
created: 2026-02-11T00:53:50Z
updated: 2026-02-11T00:55:00Z
github: https://github.com/jobu711/option_alpha_v2/issues/2
depends_on: [4]
parallel: true
conflicts_with: []
---

# Task: SQLite persistence layer

## Description
Build the SQLite persistence layer for storing scan results, per-ticker scores, AI theses, and historical data. Includes database setup with WAL mode, schema design, simple migration system, CRUD repository, and historical query API for score trends over time.

## Acceptance Criteria
- [ ] `persistence/database.py` manages SQLite connection with WAL mode enabled
- [ ] Schema: `scan_runs` table (id, timestamp, ticker_count, duration_seconds, status)
- [ ] Schema: `ticker_scores` table (id, scan_run_id, ticker, composite_score, direction, score_breakdown_json, options_recommendation_json)
- [ ] Schema: `ai_theses` table (id, scan_run_id, ticker, bull_thesis, bear_thesis, risk_synthesis, conviction, recommendation)
- [ ] Simple migration system: version-tracked SQL scripts in `persistence/migrations/`
- [ ] `persistence/repository.py` with CRUD: save_scan_run, save_ticker_scores (batch), save_ai_theses, get_latest_scan, get_ticker_history
- [ ] Historical query: get score trend for a ticker over last N days
- [ ] WAL mode for concurrent read/write safety
- [ ] Unit tests with in-memory SQLite database

## Technical Details
- SQLite via stdlib `sqlite3` module (no ORM needed for this scale)
- WAL mode: `PRAGMA journal_mode=WAL` on connection
- Migrations: simple numbered SQL files (001_initial.sql, etc.) with a `schema_version` table
- Score breakdown stored as JSON string in SQLite (deserialize to Pydantic model on read)
- Batch insert for ticker_scores using `executemany()`
- Index on (ticker, scan_run_id) for historical queries

## Dependencies
- [ ] Task 001 (shared Pydantic models from models.py)

## Effort Estimate
- Size: M
- Hours: 5-6
- Parallel: true (can be built alongside Tasks 2-4)

## Definition of Done
- [ ] Code implemented
- [ ] Tests written and passing
- [ ] Migrations run cleanly on fresh database
