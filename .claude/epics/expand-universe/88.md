---
name: REST API routes for universe CRUD
status: open
created: 2026-02-13T21:15:40Z
updated: 2026-02-13T21:24:02Z
github: https://github.com/jobu711/option_alpha_v2/issues/88
depends_on: [86]
parallel: true
conflicts_with: []
---

# Task: REST API routes for universe CRUD

## Description

Create REST API endpoints for managing the universe: ticker CRUD, tag CRUD, bulk operations, and typeahead search. These endpoints power the dashboard UI (Task 005) via HTMX and also serve as a standalone API. Follow existing route patterns in `web/routes.py` — use a new `APIRouter` in a new `web/universe_routes.py` module.

## Acceptance Criteria

- [ ] New file `src/option_alpha/web/universe_routes.py` with its own `APIRouter`
- [ ] Router registered in `web/app.py` via `app.include_router()`
- [ ] `GET /universe` — renders the universe dashboard page (returns HTML template)
- [ ] `GET /api/universe/tickers` — list tickers, filterable by tag slug, active status, search query; paginated (50 per page default)
- [ ] `POST /api/universe/tickers` — add ticker(s) with tag assignments
- [ ] `PATCH /api/universe/tickers/{symbol}` — toggle active/inactive, update tags
- [ ] `DELETE /api/universe/tickers/{symbol}` — remove a ticker
- [ ] `GET /api/universe/tags` — list all tags with ticker counts
- [ ] `POST /api/universe/tags` — create a new tag
- [ ] `PATCH /api/universe/tags/{slug}` — toggle tag active, rename
- [ ] `DELETE /api/universe/tags/{slug}` — delete a tag (untags tickers, doesn't delete them)
- [ ] `POST /api/universe/tickers/bulk` — bulk activate/deactivate/tag/remove
- [ ] `GET /api/universe/search?q=` — typeahead search against existing universe tickers by symbol/name
- [ ] Endpoints return HTMX partials where appropriate (for dashboard interactivity) and JSON for API use
- [ ] Error handling: proper HTTP status codes (400, 404, 409 for empty universe prevention)

## Technical Details

### Router setup

```python
# src/option_alpha/web/universe_routes.py
from fastapi import APIRouter
router = APIRouter()
```

Register in `web/app.py`:
```python
from option_alpha.web.universe_routes import router as universe_router
app.include_router(universe_router)
```

### Route patterns

Follow existing `routes.py` conventions:
- Use `Request` for accessing `app.state.settings`
- Use `_get_db_conn(request)` pattern for database access (or import `initialize_db`)
- Return `templates.TemplateResponse()` for HTML pages
- Return `HTMLResponse` for HTMX partials
- Return `JSONResponse` for API data

### Request/response models

Use Pydantic models for request bodies:
```python
class AddTickersRequest(BaseModel):
    symbols: list[str]
    tags: list[str] = []
    source: str = "manual"

class BulkActionRequest(BaseModel):
    symbols: list[str]
    action: str  # "activate" | "deactivate" | "tag" | "untag" | "remove"
    tag_slug: str | None = None
```

### HTMX partial responses

For dashboard integration, ticker-modifying endpoints should detect HTMX requests (`HX-Request` header) and return partial HTML updates. For non-HTMX requests, return JSON.

### Typeahead search

`GET /api/universe/search?q=AAPL` searches existing `universe_tickers` by symbol LIKE or name LIKE. Returns JSON array of matches (max 20). No external API calls in MVP — only searches local DB.

### Files affected
- `src/option_alpha/web/universe_routes.py` (new)
- `src/option_alpha/web/app.py` (register router)
- `tests/test_universe_routes.py` (new, optional — can be deferred)

## Dependencies

- [ ] Task #86 (Universe service layer for all CRUD operations)

## Effort Estimate

- Size: M
- Hours: 3-4
- Parallel: true (independent of Task 003; blocks Task 005)

## Definition of Done

- [ ] All endpoints implemented and returning correct responses
- [ ] HTMX partial responses work for dashboard integration
- [ ] Error cases handled (404 for missing ticker/tag, 400 for invalid input, 409 for empty universe)
- [ ] Router registered and accessible
- [ ] `pytest tests/` passes
