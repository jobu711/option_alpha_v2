---
name: Compress prompts and optimize context token usage
status: open
created: 2026-02-13T15:16:40Z
updated: 2026-02-13T15:26:14Z
github: https://github.com/jobu711/option_alpha_v2/issues/68
depends_on: [66]
parallel: false
conflicts_with: [66]
---

# Task: Compress prompts and optimize context token usage

## Description
Reduce token usage by compressing the Bull/Bear/Risk system prompts and optimizing the context builder output. Target: combined system prompts <850 tokens (down from ~1500), and overall 20% token reduction per scan.

## Acceptance Criteria
- [ ] Bull system prompt <250 tokens (concise bullet instructions)
- [ ] Bear system prompt <250 tokens (concise bullet instructions)
- [ ] Risk system prompt <350 tokens (concise bullet instructions)
- [ ] Combined system prompts <850 tokens (down from ~1500)
- [ ] Ticker symbol mentioned once in context header, not repeated in every section
- [ ] Score Breakdown and Signal Summary merged into a single compact "Indicators" section
- [ ] All existing prompt requirement tests still pass (price target, 3 data points, conviction rubric, etc.)
- [ ] Measurable: total tokens per 10-ticker scan reduced by at least 20%

## Technical Details

### agents.py — System prompts (~lines 34-81)

Compress while preserving all functional requirements:
- **Bull**: Must still require 3+ indicator citations, price target with timeframe, options data reference
- **Bear**: Must still require quantified downside, weakest indicator, risk scenarios
- **Risk**: Must still include conviction rubric (1-3/4-6/7-10), require entry price, stop-loss, profit target, risk/reward, position sizing, IV assessment

Strategy: Remove verbose phrasing, use terse bullet format, eliminate redundant instructions. Example:
```
Current: "You are a bullish analyst. Your job is to make the strongest possible case for buying this stock."
Compressed: "Bullish analyst. Make the strongest buy case."
```

### context.py — build_context() (~lines 273-370)

1. **Remove ticker repetition**: Mention `{symbol}` once in the header line. Remove from section headers.
2. **Merge sections**: Combine "Score Breakdown" table and "Signal Summary" into a single "Indicators" section:
   ```
   ## Indicators
   | Indicator | Value | Pctl | Wt | Signal |
   ```
   Where "Signal" column replaces the separate Signal Summary paragraph.
3. **Compact formatting**: Reduce whitespace, shorten section headers.

### Validation approach
- Count tokens using `len(prompt.split())` as rough proxy (actual tokenization varies by model)
- Compare before/after on a sample 10-ticker context

## Dependencies
- [ ] Task 006 (data-driven thresholds — context.py changes should be coordinated)

## Effort Estimate
- Size: M
- Hours: 2-3
- Parallel: false (depends on task 006 completing first to avoid merge conflicts in context.py)

## Definition of Done
- [ ] Code implemented
- [ ] System prompt tests updated for compressed text
- [ ] Token count verified <850 combined for system prompts
- [ ] Existing tests pass (may need minor updates for changed prompt text)
