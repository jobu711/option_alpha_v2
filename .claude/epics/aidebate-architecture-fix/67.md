---
name: Add retry jitter and structured error reporting
status: open
created: 2026-02-13T15:16:40Z
updated: 2026-02-13T15:26:14Z
github: https://github.com/jobu711/option_alpha_v2/issues/67
depends_on: [63]
parallel: true
conflicts_with: [64]
---

# Task: Add retry jitter and structured error reporting

## Description
Enhance `_run_agent_with_retry()` in `agents.py` with jitter on backoff delays, validation-specific retry with corrective hints, and structured error categorization using the `AgentError` model from Task 001. Improve log messages to include error category, ticker, agent role, and attempt number.

## Acceptance Criteria
- [ ] Retry backoff delays have random jitter: `delay + random.uniform(0, 0.25 * delay)`
- [ ] `ValidationError` retries append a corrective hint to the last user message before retrying
- [ ] Errors are categorized into `ErrorCategory` enum values (NETWORK, PARSE, VALIDATION, TIMEOUT, UNKNOWN)
- [ ] Log format: `[{category}] {role} for {ticker} (attempt {n}/{max}): {message}`
- [ ] `_run_agent_with_retry()` returns or raises with structured error info that callers can use to populate `AgentError`
- [ ] Existing tests pass; new tests for jitter and error categorization

## Technical Details

### agents.py — _run_agent_with_retry() (~line 106-150)

Key changes:
1. **Add jitter** (~line 137-140): Replace `await asyncio.sleep(delay)` with `await asyncio.sleep(delay + random.uniform(0, 0.25 * delay))`
2. **Validation hint retry** (~line 126-132): On `ValidationError`, instead of immediate retry, append hint to messages:
   ```python
   except ValidationError as e:
       logger.warning(f"[VALIDATION] {role} (attempt {i+1}/{max_attempts}): {e}")
       messages.append({"role": "user", "content": f"Your previous response had validation issues: {e}. Please fix."})
       # retry immediately (no sleep)
   ```
3. **Error categorization**: Map exception types to `ErrorCategory`:
   - `JSONDecodeError` → `PARSE`
   - `ValidationError` → `VALIDATION`
   - `httpx.TimeoutException` → `NETWORK`
   - `httpx.HTTPStatusError` → `NETWORK`
   - Everything else → `UNKNOWN`
4. **Structured logging**: Use the format `[{category}] {role} for {ticker} (attempt {n}/{max}): {message}`

### Function signature change
Add optional `ticker: str = ""` parameter for log context:
```python
async def _run_agent_with_retry(
    client, messages, response_model, role,
    retry_delays=None, ticker=""
) -> T:
```

### Import additions
```python
import random
from option_alpha.models import ErrorCategory
```

## Dependencies
- [ ] Task 001 (`ErrorCategory` enum in models.py)

## Effort Estimate
- Size: M
- Hours: 2-3
- Parallel: true (parallel with tasks 2, 4, 5 after task 1)

## Definition of Done
- [ ] Code implemented
- [ ] Tests for jitter (mock random), validation hint, error categorization
- [ ] Existing tests pass
