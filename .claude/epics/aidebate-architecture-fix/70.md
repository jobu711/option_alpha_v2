---
name: Add comprehensive test coverage for all changes
status: open
created: 2026-02-13T15:16:40Z
updated: 2026-02-13T15:26:14Z
github: https://github.com/jobu711/option_alpha_v2/issues/70
depends_on: [63, 65, 67, 69, 64, 66, 68]
parallel: false
conflicts_with: []
---

# Task: Add comprehensive test coverage for all changes

## Description
Add tests for all new functionality introduced in tasks 1-7. Target: 950+ total tests (up from 925+). This task covers test gaps not already addressed inline by earlier tasks — primarily integration-level tests and edge cases.

## Acceptance Criteria
- [ ] Tests for per-ticker timeout: mock a slow debate, verify fallback returned with TIMEOUT error
- [ ] Tests for deterministic ordering: verify results sorted by composite_score descending after concurrent execution
- [ ] Tests for retry jitter: mock `random.uniform`, verify jitter applied to sleep delays
- [ ] Tests for validation hint retry: verify corrective hint appended to messages on ValidationError
- [ ] Tests for context-aware fallbacks: various composite scores (10, 50, 90) and directions (BULLISH, BEARISH, NEUTRAL)
- [ ] Tests for enhanced health checks: Ollama model-loaded check, Claude API key validation, timeout scenarios
- [ ] Tests for data-driven thresholds: verify all existing indicator interpretations unchanged; test unknown indicator returns raw value
- [ ] Tests for structured error reporting: verify AgentError populated with correct category on different error types
- [ ] Tests for compressed prompts: verify prompts still contain required keywords (price target, conviction rubric, etc.)
- [ ] Tests for phase summary logging: verify log output format
- [ ] Total test count ≥ 950

## Technical Details

### tests/test_ai.py — New test classes/functions to add

```python
class TestPerTickerTimeout:
    async def test_timeout_returns_fallback(self): ...
    async def test_timeout_error_category(self): ...
    async def test_other_tickers_unaffected(self): ...

class TestDeterministicOrdering:
    async def test_results_sorted_by_composite_score(self): ...
    async def test_ordering_with_fallbacks(self): ...

class TestRetryJitter:
    async def test_jitter_applied_to_delays(self): ...
    async def test_validation_hint_appended(self): ...

class TestContextAwareFallbacks:
    def test_high_score_bullish_fallback(self): ...
    def test_low_score_bearish_fallback(self): ...
    def test_none_ticker_score_backward_compat(self): ...

class TestEnhancedHealthChecks:
    async def test_ollama_model_loaded(self): ...
    async def test_ollama_model_not_loaded(self): ...
    async def test_claude_api_key_invalid(self): ...
    async def test_health_check_timeout(self): ...

class TestStructuredErrors:
    def test_network_error_category(self): ...
    def test_parse_error_category(self): ...
    def test_validation_error_category(self): ...
    def test_agent_error_model(self): ...

class TestPhaseSummaryLogging:
    async def test_summary_log_format(self): ...
```

### Mocking strategy
- **Timeout**: `AsyncMock(side_effect=asyncio.TimeoutError)` for slow debates
- **Jitter**: `@patch("random.uniform", return_value=0.5)` to verify jitter calculation
- **Health checks**: `respx` or `httpx.MockTransport` for HTTP responses
- **Ordering**: Create multiple mock debates completing in random order, verify final sort

## Dependencies
- [ ] All tasks 001-007 must be complete

## Effort Estimate
- Size: L
- Hours: 3-4
- Parallel: false (runs after all implementation tasks)

## Definition of Done
- [ ] All new tests pass
- [ ] All existing tests pass
- [ ] Total test count ≥ 950
- [ ] `pytest tests/ --cov=option_alpha` shows no regression in coverage
