---
name: Add per-ticker timeout and deterministic result ordering
status: open
created: 2026-02-13T15:16:40Z
updated: 2026-02-13T15:26:14Z
github: https://github.com/jobu711/option_alpha_v2/issues/69
depends_on: [63]
parallel: true
conflicts_with: []
---

# Task: Add per-ticker timeout and deterministic result ordering

## Description
Wrap each individual debate in `asyncio.wait_for()` with the new `ai_per_ticker_timeout` setting, and sort results by `composite_score` descending after all debates complete. Populate `composite_score` and `error` fields on `DebateResult`. Add phase summary logging.

## Acceptance Criteria
- [ ] Each `run_debate()` call wrapped in `asyncio.wait_for(timeout=settings.ai_per_ticker_timeout)`
- [ ] On `asyncio.TimeoutError`, returns fallback `DebateResult` with `error=AgentError(category=TIMEOUT, ...)`
- [ ] `composite_score` populated on every `DebateResult` (from `TickerScore.composite_score`)
- [ ] After `asyncio.gather()`, results sorted by `composite_score` descending
- [ ] Phase summary logged: "Completed {n}/{total} debates ({failures} failures) in {elapsed:.1f}s"
- [ ] Per-ticker timing logged at DEBUG level
- [ ] Phase-level timeout (`ai_debate_phase_timeout`) remains as backstop
- [ ] Existing tests pass

## Technical Details

### debate.py â€” run_debates() (~line 93-169)

Key changes to `_run_single()` inner function:
```python
async def _run_single(score, sem):
    async with sem:
        start = time.monotonic()
        try:
            result = await asyncio.wait_for(
                self.run_debate(score, options_recs.get(score.symbol), settings),
                timeout=settings.ai_per_ticker_timeout,
            )
            result.composite_score = score.composite_score
        except asyncio.TimeoutError:
            logger.warning(f"Debate timed out for {score.symbol} after {settings.ai_per_ticker_timeout}s")
            result = _fallback_debate_result(score.symbol)
            result.composite_score = score.composite_score
            result.error = AgentError(
                category=ErrorCategory.TIMEOUT,
                message=f"Debate timed out after {settings.ai_per_ticker_timeout}s",
                agent_role="debate",
                attempt=0,
            )
        except Exception as e:
            logger.error(f"Debate failed for {score.symbol}: {e}")
            result = _fallback_debate_result(score.symbol)
            result.composite_score = score.composite_score
            result.error = AgentError(
                category=ErrorCategory.UNKNOWN,
                message=str(e),
                agent_role="debate",
                attempt=0,
            )
        elapsed = time.monotonic() - start
        logger.debug(f"Debate for {score.symbol} completed in {elapsed:.1f}s")
        return result
```

After gather:
```python
# Sort by composite_score descending
results.sort(key=lambda r: r.composite_score or 0, reverse=True)

# Phase summary
failures = sum(1 for r in results if r.error is not None)
logger.info(f"Completed {len(results)}/{total} debates ({failures} failures) in {phase_elapsed:.1f}s")
```

### Import additions
```python
import time
from option_alpha.models import AgentError, ErrorCategory
```

## Dependencies
- [ ] Task 001 (`ai_per_ticker_timeout` setting, `AgentError` model, `composite_score` field on `DebateResult`)

## Effort Estimate
- Size: M
- Hours: 2-3
- Parallel: true (parallel with tasks 2, 3, 5 after task 1)

## Definition of Done
- [ ] Code implemented
- [ ] Tests for per-ticker timeout (mock slow debate), result ordering, phase summary
- [ ] Existing tests pass
