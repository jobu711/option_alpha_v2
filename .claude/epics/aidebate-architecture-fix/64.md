---
name: Implement context-aware fallback responses
status: open
created: 2026-02-13T15:16:40Z
updated: 2026-02-13T15:26:14Z
github: https://github.com/jobu711/option_alpha_v2/issues/64
depends_on: [63]
parallel: true
conflicts_with: [67]
---

# Task: Implement context-aware fallback responses

## Description
Change fallback functions in `agents.py` to accept `TickerScore` and derive conviction/direction from pre-computed scoring data instead of always returning neutral/conviction=3.

## Acceptance Criteria
- [ ] `_fallback_agent_response(role, ticker_score=None)` accepts optional `TickerScore`
- [ ] When `ticker_score` provided: conviction = `max(2, min(8, round(score / 12.5)))`
- [ ] When `ticker_score` provided: fallback analysis references composite score and direction
- [ ] `_fallback_thesis(symbol, ticker_score=None)` uses `ticker_score.direction` instead of `NEUTRAL`
- [ ] `_fallback_thesis` conviction derived from composite score (same formula)
- [ ] `_fallback_debate_result()` accepts optional `ticker_score` and passes it through
- [ ] When `ticker_score` is None, behavior is unchanged (backward compatible)
- [ ] Existing tests pass

## Technical Details

### agents.py — _fallback_agent_response() (~line 84-91)
```python
def _fallback_agent_response(role: str, ticker_score=None) -> AgentResponse:
    if ticker_score:
        conviction = max(2, min(8, round(ticker_score.composite_score / 12.5)))
        direction = ticker_score.direction.value
        analysis = f"[FALLBACK] Automated fallback based on composite score {ticker_score.composite_score:.1f} ({direction})"
    else:
        conviction = 3
        analysis = f"[FALLBACK] Unable to complete {role} analysis."
    return AgentResponse(
        role=role,
        analysis=analysis,
        key_points=["Fallback response - LLM unavailable"],
        conviction=conviction,
    )
```

### agents.py — _fallback_thesis() (~line 94-103)
```python
def _fallback_thesis(symbol: str, ticker_score=None) -> TradeThesis:
    if ticker_score:
        direction = ticker_score.direction
        conviction = max(2, min(8, round(ticker_score.composite_score / 12.5)))
        rationale = f"Automated fallback based on composite score {ticker_score.composite_score:.1f} ({direction.value})"
    else:
        direction = Direction.NEUTRAL
        conviction = 3
        rationale = "Unable to complete analysis"
    return TradeThesis(
        symbol=symbol,
        direction=direction,
        conviction=conviction,
        entry_rationale=rationale,
        ...
    )
```

### Callers to update
- `run_bull_agent()`, `run_bear_agent()`, `run_risk_agent()` — pass `ticker_score` to fallback calls
- `_fallback_debate_result()` in `debate.py` — accept and pass `ticker_score`

## Dependencies
- [ ] Task 001 (`DebateResult` model fields)

## Effort Estimate
- Size: S
- Hours: 1-2
- Parallel: true (parallel with tasks 2, 3, 4 after task 1; conflicts with 003 on agents.py)

## Definition of Done
- [ ] Code implemented
- [ ] Tests for fallback with various composite scores and directions
- [ ] Backward-compatible when ticker_score=None
- [ ] Existing tests pass
