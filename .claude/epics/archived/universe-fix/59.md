---
name: Tests for universe refresh overhaul
status: open
created: 2026-02-12T13:08:06Z
updated: 2026-02-12T13:15:04Z
github: https://github.com/jobu711/option_alpha_v2/issues/59
depends_on: [57, 60, 61, 56, 58]
parallel: false
conflicts_with: []
---

# Task: Tests for universe refresh overhaul

## Description
Write comprehensive tests covering OI validation, atomic writes, ETF preservation, regeneration modes, scheduler setup, and the new config settings. All tests should use mocked yfinance data (no live API calls). Ensure existing tests continue to pass.

## Acceptance Criteria
- [ ] Unit tests for `_validate_open_interest()`: tickers above/below threshold, ETF bypass, API failure handling, rate limiting behavior
- [ ] Unit tests for atomic write: verify `.tmp` write, `.bak` backup, rename sequence; verify rollback on failure
- [ ] Unit tests for ETF preservation: ETFs survive stock regeneration unchanged
- [ ] Unit tests for universe size warnings: below 500, above 1500, within range
- [ ] Unit tests for new config settings: `min_universe_oi`, `universe_refresh_schedule` defaults and serialization
- [ ] Unit tests for regeneration mode: `regenerate=True` vs `regenerate=False` behavior
- [ ] Integration test: full refresh pipeline with mocked yfinance producing valid `universe_data.json`
- [ ] Test for scheduler setup: verify APScheduler job is registered with correct trigger
- [ ] All existing tests pass without modification

## Technical Details
- File: `tests/test_universe_refresh.py` (new or extend existing)
- File: `tests/test_config.py` (extend with new settings tests)
- Mock `yf.Ticker` to return controlled options data with specific OI values
- Mock `yf.download` for price/volume data
- Use `tmp_path` fixture for file system tests (atomic writes, backups)
- Mock `httpx.AsyncClient` for SEC EDGAR calls
- For scheduler tests: verify job registration without actually running the scheduler long-term
- Test edge cases: empty options chain, zero OI, ticker that raises exceptions, all tickers failing

## Dependencies
- [ ] All previous tasks (57-58) must be complete

## Effort Estimate
- Size: M
- Hours: 5
- Parallel: false (requires all other tasks to be done)

## Definition of Done
- [ ] All new tests written and passing
- [ ] All existing tests still pass
- [ ] Test coverage for new code paths verified
- [ ] Edge cases covered
