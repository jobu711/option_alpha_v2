---
name: Update tests for 5-phase pipeline and new debate endpoint
status: open
created: 2026-02-14T00:12:02Z
updated: 2026-02-14T00:12:02Z
github: https://github.com/jobu711/option_alpha_v2/issues/96
depends_on: [91, 93, 94]
parallel: false
conflicts_with: []
---

# Task: Update tests for 5-phase pipeline and new debate endpoint

## Description
Update existing integration tests to reflect the 5-phase pipeline (no `ai_debate` phase) and add new tests for the `POST /debate` endpoint covering happy path, guard conditions, persistence, and error handling.

## Acceptance Criteria
- [ ] `test_scan_trigger_returns_progress` asserts 5 phases without `ai_debate`
- [ ] `test_full_orchestrator_with_mocks` no longer mocks `get_client` in orchestrator context and expects `debate_results=[]` (or `top_n_debated=0`)
- [ ] New test: `POST /debate` with valid symbols returns 200 with debate results HTML
- [ ] New test: `POST /debate` returns 409 when `_scan_running` is True
- [ ] New test: `POST /debate` returns 400 when symbols not in latest scan
- [ ] New test: `POST /debate` returns 400 when no symbols provided
- [ ] New test: debate results are persisted to `ai_theses` table after endpoint call
- [ ] New test: re-debating same ticker replaces previous result (always fresh)
- [ ] All existing tests still pass

## Technical Details
- **File**: `tests/test_integration.py`
  - **Update `TestScanFlow.test_scan_trigger_returns_progress`** (line 459):
    - Change phase assertion loop to 5 phases: `["data_fetch", "scoring", "catalysts", "options", "persist"]`
    - Remove `"ai_debate"` from the assertion
  - **Update `TestFullPipeline.test_full_orchestrator_with_mocks`** (line 306):
    - Remove the `patch("option_alpha.pipeline.orchestrator.get_client")` context manager
    - Remove mock LLM client setup (mock_llm, mock_llm.complete side_effect)
    - Change assertion: `assert len(result.debate_results) == 0` and `assert result.top_n_debated == 0`
  - **New test class `TestDebateEndpoint`**:
    - `test_debate_valid_symbols`: Seed DB, mock `get_client` + `DebateManager.run_debate`, POST `/debate` with JSON `{"symbols": ["AAPL"]}`, assert 200, assert HTML contains debate content
    - `test_debate_rejected_during_scan`: Set `_scan_running = True`, POST `/debate`, assert 409
    - `test_debate_invalid_symbols`: Seed DB, POST with `{"symbols": ["INVALID"]}`, assert 400
    - `test_debate_empty_symbols`: POST with `{"symbols": []}`, assert 400
    - `test_debate_persists_results`: After successful debate POST, query `ai_theses` table, assert row exists
    - `test_debate_replaces_existing`: Seed an existing debate, POST again for same ticker, assert only 1 row (replaced)

## Dependencies
- [ ] Issue #1 (pipeline changed to 5 phases)
- [ ] Issue #2 (POST /debate endpoint exists)
- [ ] Issue #5 (_debate_results.html template exists for endpoint to render)

## Effort Estimate
- Size: M
- Hours: 2-3
- Parallel: false (depends on all implementation tasks)

## Definition of Done
- [ ] All existing tests updated and passing
- [ ] New debate endpoint tests written and passing
- [ ] `pytest tests/` passes with 0 failures
- [ ] No skipped tests related to this epic
