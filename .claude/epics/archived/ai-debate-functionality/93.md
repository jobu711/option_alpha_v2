---
name: Add POST /debate endpoint to web routes
status: open
created: 2026-02-14T00:12:02Z
updated: 2026-02-14T00:12:02Z
github: https://github.com/jobu711/option_alpha_v2/issues/93
depends_on: [91]
parallel: false
conflicts_with: [91]
---

# Task: Add POST /debate endpoint to web routes

## Description
Add a new `POST /debate` endpoint that accepts a list of ticker symbols, runs on-demand AI debates for each, persists results to the `ai_theses` table, and returns an HTMX partial with the debate results for inline rendering on the dashboard.

## Acceptance Criteria
- [ ] `POST /debate` accepts JSON body `{"symbols": ["AAPL", "TSLA"]}`
- [ ] Returns 409 (Conflict) if `_scan_running` is True
- [ ] Returns 400 if no symbols provided or symbols not found in latest scan
- [ ] Runs `DebateManager.run_debate()` for each requested symbol
- [ ] Deletes existing `ai_theses` rows for same `(scan_run_id, ticker)` before inserting (always fresh)
- [ ] Persists results via `save_ai_theses()`
- [ ] Returns `_debate_results.html` partial with debate results
- [ ] Individual ticker failures don't block other tickers (graceful per-ticker error handling)
- [ ] Adds a `_debate_running` flag to prevent concurrent debate requests

## Technical Details
- **File**: `src/option_alpha/web/routes.py`
  - Add imports: `get_client` from `ai.clients`, `DebateManager` from `ai.debate`, `DebateResult` from `models`
  - Add module-level `_debate_running = False` flag
  - New endpoint `POST /debate`:
    1. Check `_scan_running` -> 409 if True
    2. Check `_debate_running` -> 409 if True (prevent concurrent debates)
    3. Parse `symbols` from JSON body
    4. Validate: get latest scan, look up scan_db_id, get scores, filter to requested symbols
    5. Return 400 if any symbol not found in latest scan scores
    6. Set `_debate_running = True`
    7. Instantiate `get_client(settings)` and `DebateManager(client)`
    8. For each symbol: find its `TickerScore`, call `manager.run_debate(ticker_score)`
    9. DELETE existing `ai_theses` rows: `DELETE FROM ai_theses WHERE scan_run_id = ? AND ticker IN (?...)`
    10. Call `save_ai_theses(conn, scan_db_id, results)`
    11. Set `_debate_running = False` in finally block
    12. Return `_debate_results.html` partial with results list
  - Expose `_debate_running` so dashboard template can check it

## Dependencies
- [ ] Issue #1 (ai_debate removed from pipeline, so no conflict with scan)
- [ ] Issue #5 (`_debate_results.html` template must exist -- can use a placeholder initially)

## Effort Estimate
- Size: M
- Hours: 2-3
- Parallel: false (depends on Issue #1)

## Definition of Done
- [ ] Endpoint implemented and reachable
- [ ] Guard conditions return correct HTTP status codes
- [ ] Debates run and results persist to DB
- [ ] Partial HTML returned for HTMX rendering
