---
name: Reorder pipeline phases with checkpoint persist and health check gating
status: open
created: 2026-02-11T18:41:29Z
updated: 2026-02-11T18:41:29Z
github: https://github.com/jobu711/option_alpha_v2/issues/39
depends_on: [35, 37, 38]
parallel: false
conflicts_with: []
---

# Task: Reorder pipeline phases with checkpoint persist and health check gating

## Description
This is the integration task. Reorder the pipeline so Persist runs as phase 5 and AI Debate as phase 6. Split the existing `_phase_persist` into a checkpoint persist (saves scores + options with `PARTIAL` status) and a post-debate finalize step (updates scan run to `COMPLETED`). Add LLM health check gating before the debate loop.

## Acceptance Criteria
- [ ] `PHASE_NAMES` reordered to: `["data_fetch", "scoring", "catalysts", "options", "persist", "ai_debate"]`
- [ ] Phase 5 (persist) saves `ScanRun` with `status=PARTIAL`, saves `TickerScore` records, returns `scan_db_id`
- [ ] Phase 6 (AI debate) calls `client.health_check()` before starting debates; skips debates if unhealthy
- [ ] Phase 6 passes `settings` to `DebateManager.run_debates()` for concurrency + timeout
- [ ] After debate completes, calls `update_scan_run()` to set final `status`, `debates_completed`, `duration_seconds`
- [ ] If debate fails entirely, scan run stays `PARTIAL` — scores are safe
- [ ] If debate succeeds, scan run updates to `COMPLETED`
- [ ] `scan_db_id` flows from phase 5 persist to phase 6 post-debate update
- [ ] `run_scan()` return value (`ScanResult`) unchanged
- [ ] Progress tracking (WebSocket) reflects new phase order correctly

## Technical Details
**Files:**
- `src/option_alpha/pipeline/orchestrator.py` — Primary: reorder, split persist, add health check

**Changes to `run_scan()`:**
```python
# Phase 5 is now persist (checkpoint)
scan_db_id = await self._phase_checkpoint(...)

# Phase 6 is now AI debate
debate_results = await self._phase_ai_debate(
    ticker_scores, options_recs, scan_db_id, progress, on_progress, scan_start, errors,
)
```

**New `_phase_checkpoint` (replaces `_phase_persist`):**
- Save `ScanRun` with `status=PARTIAL`
- Save ticker scores
- Return `scan_db_id`

**Updated `_phase_ai_debate`:**
- Accept `scan_db_id` parameter
- Call `client.health_check()` at the start; if False, log error + skip debates
- Pass settings to `DebateManager.run_debates()` for concurrency/timeout
- After debates, call `update_scan_run(conn, scan_db_id, status=COMPLETED, debates_completed=len(results), ...)`
- Save AI theses via `save_ai_theses(conn, scan_db_id, debate_results)`

**Health check gating:**
```python
client = get_client(self.settings)
if not await client.health_check():
    logger.error("LLM health check failed — skipping AI debate phase")
    # phase completes with 0 debates, scan stays PARTIAL
    return []
```

## Dependencies
- [ ] #35 — Settings with AI config
- [ ] #37 — Concurrent debate execution in `debate.py`
- [ ] #38 — `update_scan_run()` in repository

## Effort Estimate
- Size: M
- Hours: 1.0
- Parallel: false (integrates all prior tasks)

## Definition of Done
- [ ] Pipeline runs in new order: Data → Scoring → Catalysts → Options → Persist → AI Debate
- [ ] Scores persisted before debate starts
- [ ] Health check gates debate phase
- [ ] Post-debate update finalizes scan run
- [ ] Existing tests still pass (with phase ordering adjustments)
