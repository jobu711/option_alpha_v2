---
name: Extract shared agent retry helper with backoff and error differentiation
status: open
created: 2026-02-11T18:41:29Z
updated: 2026-02-11T18:41:29Z
github: https://github.com/jobu711/option_alpha_v2/issues/36
depends_on: [35]
parallel: false
conflicts_with: []
---

# Task: Extract shared agent retry helper with backoff and error differentiation

## Description
The three agent functions (`run_bull_agent`, `run_bear_agent`, `run_risk_agent`) contain nearly identical retry loops with zero delay between attempts. Extract a shared `_run_agent_with_retry()` async helper that:
1. Adds `asyncio.sleep()` with configurable exponential backoff between retries
2. Differentiates JSON parse errors from network/timeout errors
3. Replaces the inline retry loops in all three agent functions

## Acceptance Criteria
- [ ] New `_run_agent_with_retry()` coroutine in `ai/agents.py` handles all retry logic
- [ ] Retries sleep for `ai_retry_delays[attempt_index]` between attempts (default `[2.0, 4.0, 8.0]`)
- [ ] `json.JSONDecodeError` and `pydantic.ValidationError` are caught separately — logged at DEBUG, retry immediately (no sleep, parse errors are fast failures)
- [ ] `httpx.TimeoutException` and `httpx.HTTPStatusError` are caught separately — logged at WARNING, sleep before retry
- [ ] All three agent functions (`run_bull_agent`, `run_bear_agent`, `run_risk_agent`) use the shared helper
- [ ] `MAX_RETRIES` constant still controls retry count (derived from `len(retry_delays)`)
- [ ] Fallback behavior unchanged — agents return conservative defaults on total failure
- [ ] Settings `ai_retry_delays` is passed through (accepted as parameter or read from config)

## Technical Details
**Files:**
- `src/option_alpha/ai/agents.py` — Primary file: add helper, refactor 3 agent functions

**Helper signature:**
```python
async def _run_agent_with_retry(
    client: LLMClient,
    messages: list[dict[str, str]],
    response_model: type[T],
    role: str,
    retry_delays: list[float] | None = None,
) -> T:
```

**Error handling strategy:**
- Parse errors (`JSONDecodeError`, `ValidationError`): DEBUG log, immediate retry (no sleep) — these are fast failures from malformed LLM output
- Network errors (`TimeoutException`, `HTTPStatusError`): WARNING log, sleep `retry_delays[i]` — transient issues that may resolve with backoff
- Other `Exception`: WARNING log, sleep `retry_delays[i]` — defensive catch-all

**Key constraint:** Agent functions still need to set `result.role` / `result.symbol` after the helper returns, so the helper returns the raw parsed model.

## Dependencies
- [ ] #35 — Settings with `ai_retry_delays`

## Effort Estimate
- Size: S
- Hours: 0.5
- Parallel: false (#37 depends on this)

## Definition of Done
- [ ] Shared retry helper implemented
- [ ] All 3 agent functions refactored to use helper
- [ ] Parse errors logged at DEBUG, network errors at WARNING
- [ ] `asyncio.sleep()` called with configured delays
- [ ] Existing tests still pass
