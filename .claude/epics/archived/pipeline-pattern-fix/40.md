---
name: Update and add tests for retry, concurrency, health check, and phase ordering
status: open
created: 2026-02-11T18:41:29Z
updated: 2026-02-11T18:41:29Z
github: https://github.com/jobu711/option_alpha_v2/issues/40
depends_on: [35, 36, 37, 38, 39]
parallel: false
conflicts_with: []
---

# Task: Update and add tests for retry, concurrency, health check, and phase ordering

## Description
Update existing tests that assert phase ordering and add new tests covering: agent retry backoff delays, concurrent debate execution, LLM health check gating, checkpoint persist with `PARTIAL` status, and post-debate scan run update.

## Acceptance Criteria
- [ ] Existing tests updated for new phase order (`PHASE_NAMES` sequence)
- [ ] Test: agent retry helper sleeps with configured delays on timeout errors
- [ ] Test: agent retry helper does NOT sleep on parse errors (immediate retry)
- [ ] Test: concurrent debates with mock client — multiple debates run in parallel
- [ ] Test: concurrency=1 produces sequential execution
- [ ] Test: debate phase timeout returns partial results
- [ ] Test: health check failure skips debate phase gracefully
- [ ] Test: checkpoint persist saves scores with `PARTIAL` status
- [ ] Test: post-debate update changes status to `COMPLETED`
- [ ] Test: debate failure leaves scan run as `PARTIAL` (data preserved)
- [ ] Test: `update_scan_run()` updates only specified fields
- [ ] Full test suite passes: `pytest tests/`

## Technical Details
**Files:**
- `tests/test_ai_agents.py` — Update/add retry backoff tests
- `tests/test_ai_debate.py` — Add concurrency and timeout tests
- `tests/test_pipeline.py` or `tests/test_orchestrator.py` — Update phase ordering, add health check and checkpoint tests
- `tests/test_persistence.py` or `tests/test_repository.py` — Add `update_scan_run()` tests

**Test patterns to use:**
- `unittest.mock.patch("asyncio.sleep")` to assert backoff delays without actual sleeping
- Mock `LLMClient` with configurable `health_check()` return value
- Mock `client.complete()` to simulate JSON parse errors vs timeout errors
- Use `time.perf_counter()` to verify concurrent debates overlap in time

**Key test scenarios:**
1. **Retry backoff**: Mock client raises `httpx.TimeoutException` 3 times → assert `asyncio.sleep` called with `[2.0, 4.0, 8.0]`
2. **Parse error fast retry**: Mock client returns invalid JSON → assert `asyncio.sleep` NOT called
3. **Concurrent debates**: Mock client with 0.1s delay, run 3 debates → total time < 0.3s (not 0.9s)
4. **Health check skip**: Mock `health_check()` → False, run pipeline → assert 0 debates, scores persisted
5. **Checkpoint persist**: Run pipeline, kill debate → assert `scan_runs.status = 'partial'`, scores in DB

## Dependencies
- [ ] All prior tasks (#35-#39) must be complete

## Effort Estimate
- Size: M
- Hours: 0.75
- Parallel: false (must run after all implementation tasks)

## Definition of Done
- [ ] All new tests passing
- [ ] All existing tests passing
- [ ] `pytest tests/` green with 0 failures
- [ ] No test regressions from phase reordering
