---
name: Universe service layer
status: open
created: 2026-02-13T21:15:40Z
updated: 2026-02-13T21:24:02Z
github: https://github.com/jobu711/option_alpha_v2/issues/86
depends_on: [85]
parallel: false
conflicts_with: []
---

# Task: Universe service layer

## Description

Create `data/universe_service.py` — the central module for all universe CRUD operations. This replaces direct use of the hardcoded lists with database-backed queries. Includes a backward-compatible `get_full_universe()` wrapper so existing code (orchestrator, tests) continues to work without changes. Also includes the auto-seeding logic from Task 001.

## Acceptance Criteria

- [ ] New module `src/option_alpha/data/universe_service.py` created
- [ ] `get_active_universe(db_path) -> list[str]`: returns all active tickers (tickers with `is_active=1` that belong to at least one active tag, or are individually active)
- [ ] `get_full_universe(db_path) -> list[str]`: backward-compat wrapper returning all tickers (same sorted, deduplicated list as current `universe.py`)
- [ ] `get_tickers_by_tag(db_path, tag_slug) -> list[str]`
- [ ] `get_all_tags(db_path) -> list[dict]`: returns tag info with ticker counts
- [ ] `add_tickers(db_path, symbols, tags, source)`: insert tickers with tag associations
- [ ] `remove_tickers(db_path, symbols)`: delete tickers and their tag associations
- [ ] `toggle_ticker(db_path, symbol, active)`: toggle ticker active/inactive; reject if would result in 0 active tickers
- [ ] `toggle_tag(db_path, tag_slug, active)`: toggle all tickers in tag; reject if would result in 0 active tickers
- [ ] `create_tag(db_path, name) -> dict`: create a new tag (auto-generates slug)
- [ ] `delete_tag(db_path, tag_slug)`: delete tag and untag tickers (doesn't delete tickers)
- [ ] `tag_tickers(db_path, symbols, tag_slug)` and `untag_tickers(db_path, symbols, tag_slug)`
- [ ] `seed_universe(db_path)`: idempotent seeding from hardcoded lists (from Task #85 spec)
- [ ] All mutations wrapped in transactions
- [ ] Unit tests in `tests/test_universe_service.py`

## Technical Details

### Module pattern

Follow `repository.py` conventions:
- Functions take `db_path` (or `conn`) as first argument
- Use `get_connection()` / `initialize_db()` from `persistence/database.py`
- Use `sqlite3.Row` factory for dict-like access
- Parameter binding for all queries (no string formatting)
- Batch operations with `executemany` where possible

### Key query: `get_active_universe()`

```sql
SELECT DISTINCT ut.symbol
FROM universe_tickers ut
JOIN ticker_tags tt ON ut.symbol = tt.symbol
JOIN universe_tags tg ON tt.tag_id = tg.id
WHERE ut.is_active = 1 AND tg.is_active = 1
ORDER BY ut.symbol
```

### Empty universe prevention

`toggle_ticker` and `toggle_tag` must check the result count before committing:
```python
# Before committing a deactivation, verify at least 1 active ticker remains
count = conn.execute("SELECT COUNT(*) FROM universe_tickers WHERE is_active = 1").fetchone()[0]
if count == 0:
    conn.rollback()
    raise ValueError("Cannot deactivate: would result in empty universe")
```

### Slug generation

Convert tag name to slug: lowercase, replace spaces with hyphens, strip non-alphanumeric.
- "S&P 500" → "sp-500"
- "Popular Options" → "popular-options"
- "Optionable ETFs" → "optionable-etfs"

### Files affected
- `src/option_alpha/data/universe_service.py` (new)
- `tests/test_universe_service.py` (new)

## Dependencies

- [ ] Task #85 (DB schema migration)

## Effort Estimate

- Size: M
- Hours: 4-5
- Parallel: false (blocks Tasks 003, 004)

## Definition of Done

- [ ] All CRUD functions implemented and working
- [ ] `get_full_universe()` returns identical 702-ticker sorted list as current hardcoded version
- [ ] Seeding is idempotent and transactional
- [ ] Empty universe prevention works (toggle rejects when it would leave 0 active)
- [ ] Unit tests cover all operations including edge cases
- [ ] `pytest tests/` passes (all existing + new tests)
