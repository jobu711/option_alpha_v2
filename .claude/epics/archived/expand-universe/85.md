---
name: DB schema, migration, and seeding
status: open
created: 2026-02-13T21:15:40Z
updated: 2026-02-13T21:24:02Z
github: https://github.com/jobu711/option_alpha_v2/issues/85
depends_on: []
parallel: false
conflicts_with: []
---

# Task: DB schema, migration, and seeding

## Description

Create the database schema for the universe management system: three new tables (`universe_tickers`, `universe_tags`, `ticker_tags`) with appropriate indexes. Add a new SQL migration file following the existing migration pattern. Implement auto-seeding logic that populates the tables from the current hardcoded lists (`SP500_CORE`, `POPULAR_OPTIONS`, `OPTIONABLE_ETFS`) on first run.

## Acceptance Criteria

- [ ] New migration file `002_universe.sql` in `src/option_alpha/persistence/migrations/`
- [ ] `universe_tickers` table created with columns: symbol (PK), name, sector, source, is_active, created_at, last_scanned_at
- [ ] `universe_tags` table created with columns: id (PK), name (UNIQUE), slug (UNIQUE), is_preset, is_active, created_at
- [ ] `ticker_tags` join table created with columns: symbol (FK), tag_id (FK), composite PK
- [ ] Indexes created: `universe_tickers(is_active)`, `universe_tags(slug)`, `universe_tags(is_preset)`, `ticker_tags(tag_id)`
- [ ] Migration applies cleanly via existing `run_migrations()` in `database.py`
- [ ] Seeding logic populates 702 tickers from hardcoded lists with 3 preset tags: "S&P 500", "Popular Options", "Optionable ETFs"
- [ ] All seeded tickers marked `is_active=1`, `source='preset'`
- [ ] Tickers appearing in multiple lists get multiple tag associations (many-to-many)
- [ ] Seeding is idempotent — only runs if `universe_tickers` table is empty

## Technical Details

### Migration file: `src/option_alpha/persistence/migrations/002_universe.sql`

```sql
CREATE TABLE IF NOT EXISTS universe_tickers (
    symbol TEXT PRIMARY KEY,
    name TEXT,
    sector TEXT,
    source TEXT NOT NULL DEFAULT 'preset',
    is_active INTEGER NOT NULL DEFAULT 1,
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    last_scanned_at TEXT
);

CREATE TABLE IF NOT EXISTS universe_tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    slug TEXT NOT NULL UNIQUE,
    is_preset INTEGER NOT NULL DEFAULT 0,
    is_active INTEGER NOT NULL DEFAULT 1,
    created_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS ticker_tags (
    symbol TEXT NOT NULL REFERENCES universe_tickers(symbol) ON DELETE CASCADE,
    tag_id INTEGER NOT NULL REFERENCES universe_tags(id) ON DELETE CASCADE,
    PRIMARY KEY (symbol, tag_id)
);

CREATE INDEX IF NOT EXISTS idx_universe_tickers_active ON universe_tickers(is_active);
CREATE INDEX IF NOT EXISTS idx_universe_tags_slug ON universe_tags(slug);
CREATE INDEX IF NOT EXISTS idx_universe_tags_preset ON universe_tags(is_preset);
CREATE INDEX IF NOT EXISTS idx_ticker_tags_tag_id ON ticker_tags(tag_id);
```

### Seeding logic

Place seeding in `data/universe_service.py` (created in Task 002) or as a standalone function. Seeding should:
1. Check if `universe_tickers` has any rows — skip if non-empty
2. Import `SP500_CORE`, `POPULAR_OPTIONS`, `OPTIONABLE_ETFS` from `data/universe.py`
3. Insert 3 preset tags with `is_preset=1`
4. Batch insert all unique tickers into `universe_tickers`
5. Batch insert tag associations into `ticker_tags` (ticker may map to multiple tags)
6. Wrap in a single transaction

### Files affected
- `src/option_alpha/persistence/migrations/002_universe.sql` (new)
- Seeding logic will live in the service module created in Task 002

## Dependencies

- [ ] None — this is the foundation task

## Effort Estimate

- Size: S
- Hours: 2-3
- Parallel: false (must complete before all other tasks)

## Definition of Done

- [ ] Migration file created and applies cleanly
- [ ] `initialize_db()` automatically applies the new migration
- [ ] Tables verified with correct schema and indexes
- [ ] Seeding produces exactly 702 unique tickers across 3 preset tags
- [ ] Existing tests still pass (`pytest tests/`)
