---
name: Per-agent time budget and effective settings in debate runner
status: open
created: 2026-02-13T12:43:00Z
updated: 2026-02-13T12:46:59Z
github: https://github.com/jobu711/option_alpha_v2/issues/75
depends_on: [72]
parallel: false
conflicts_with: []
---

# Task: Per-agent time budget and effective settings in debate runner

## Description

Two related changes to make the debate runner Ollama-friendly:

1. **Use effective settings**: `DebateManager.run_debates()` should apply `get_effective_ai_settings()` from Task 001 so Ollama gets concurrency=1, 180s per-ticker timeout, etc.

2. **Per-agent time budget**: `DebateManager.run_debate()` should track elapsed time and give each sequential agent (Bull → Bear → Risk) a fair share of the remaining per-ticker budget. If remaining time is insufficient, abort early with a clear error.

3. **Per-agent progress logging**: Log which agent is running for which ticker, so users can see progress (e.g., "Running bear agent for AAPL (42s remaining)").

## Acceptance Criteria

- [ ] `run_debates()` applies `get_effective_ai_settings()` to determine concurrency, per-ticker timeout, and phase timeout
- [ ] Explicit user settings override effective defaults
- [ ] `run_debate()` tracks elapsed time per agent and passes remaining budget as timeout
- [ ] Each agent call is wrapped in `asyncio.wait_for(agent_call, timeout=remaining/agents_left)`
- [ ] If remaining budget < 10s before next agent, abort with TIMEOUT error
- [ ] Per-agent log messages: "Running {role} agent for {symbol} ({remaining}s budget)"
- [ ] Retry delays are sourced from effective settings (not raw config)
- [ ] Existing debate tests pass (update timeout values in test Settings as needed)
- [ ] New test: per-agent budget aborts early when time is insufficient

## Technical Details

### Time Budget in run_debate()

```python
async def run_debate(self, ticker_score, options_rec=None, per_ticker_timeout=None):
    budget_start = time.monotonic()
    budget_total = per_ticker_timeout or 180  # from effective settings

    # Bull agent
    remaining = budget_total - (time.monotonic() - budget_start)
    bull = await asyncio.wait_for(
        run_bull_agent(context, self.client, ...),
        timeout=remaining * 0.4,  # ~40% of budget for bull
    )

    # Bear agent
    remaining = budget_total - (time.monotonic() - budget_start)
    if remaining < 10:
        return _fallback_debate_result(ticker_score)  # abort early
    bear = await asyncio.wait_for(
        run_bear_agent(context, bull, self.client, ...),
        timeout=remaining * 0.5,  # ~50% of remaining for bear
    )

    # Risk agent
    remaining = budget_total - (time.monotonic() - budget_start)
    if remaining < 10:
        return _fallback_debate_result(ticker_score)  # abort early
    risk = await asyncio.wait_for(
        run_risk_agent(...),
        timeout=remaining,  # all remaining for risk
    )
```

### Effective Settings Integration

In `run_debates()`:
```python
if settings is None:
    settings = get_settings()

# Apply backend-aware defaults
effective = get_effective_ai_settings(settings)
concurrency = effective["ai_debate_concurrency"]
per_ticker_timeout = effective["ai_per_ticker_timeout"]
phase_timeout = effective.get("ai_debate_phase_timeout", settings.ai_debate_phase_timeout)
```

### Files Affected
- `src/option_alpha/ai/debate.py` — Time budget logic, effective settings, per-agent logging
- `tests/test_ai.py` — Update `TestPerTickerTimeout`, `TestDebateManager` with new budget behavior

## Dependencies
- [ ] Task #72 (Backend-aware config defaults) — Need `get_effective_ai_settings()`

## Effort Estimate
- Size: M
- Parallel: false (depends on Task #72)
