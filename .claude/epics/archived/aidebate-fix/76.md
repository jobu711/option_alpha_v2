---
name: Comprehensive test updates
status: open
created: 2026-02-13T12:43:00Z
updated: 2026-02-13T12:46:59Z
github: https://github.com/jobu711/option_alpha_v2/issues/76
depends_on: [72, 73, 74, 75]
parallel: false
conflicts_with: []
---

# Task: Comprehensive test updates

## Description

Final validation task: run the full test suite, fix any remaining test failures from Tasks 001-004, and add new tests for the added functionality. Each prior task should have updated its directly affected tests, but this task catches cross-cutting issues and ensures full suite integrity.

## Acceptance Criteria

- [ ] `pytest tests/` passes with 0 failures
- [ ] All 925+ existing tests pass (no regressions)
- [ ] New test: `test_get_effective_ai_settings_ollama` — verifies Ollama defaults
- [ ] New test: `test_get_effective_ai_settings_claude` — verifies Claude defaults
- [ ] New test: `test_get_effective_ai_settings_override` — verifies user override takes precedence
- [ ] New test: `test_ollama_health_check_model_not_in_tags` — verifies health check fails when model missing from tags
- [ ] New test: `test_context_top_6_indicators_by_weight` — verifies only top 6 shown
- [ ] New test: `test_debate_budget_aborts_early` — verifies early abort when budget insufficient
- [ ] Coverage for AI module does not decrease

## Technical Details

### Test Execution
```bash
pytest tests/ -v --tb=short
pytest tests/test_ai.py -v  # Focus on AI tests
pytest tests/ --cov=option_alpha  # Check coverage
```

### Likely Test Fixes Needed

1. **Health check tests**: Tests asserting `mock_ctx.post.assert_called_once()` in health check will need updating since Ollama health check no longer calls POST
2. **Context format tests**: Assertions on table headers, `"Interpretation"` column, specific formatting strings
3. **Claude structured output tests**: Assertions on JSON schema in prompt need to check for example hint instead
4. **Timeout tests**: `TestPerTickerTimeout` may need adjusted timeout values for new defaults

### Files Affected
- `tests/test_ai.py` — Primary test file for all AI changes
- `tests/test_config.py` — If it exists, add effective settings tests (otherwise add to test_ai.py)
- Any other test files that import from `config.py` or `ai/` modules

## Dependencies
- [ ] Task #72 — Config changes
- [ ] Task #73 — Client changes
- [ ] Task #74 — Context changes
- [ ] Task #75 — Debate runner changes

## Effort Estimate
- Size: M
- Parallel: false (must run after all other tasks complete)
