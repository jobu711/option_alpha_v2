---
name: Fix sma_direction graceful degradation for insufficient data
status: open
created: 2026-02-11T22:04:49Z
updated: 2026-02-11T22:20:13Z
github: https://github.com/jobu711/option_alpha_v2/issues/44
depends_on: [42]
parallel: false
conflicts_with: [48]
---

# Task: Fix sma_direction graceful degradation for insufficient data

## Description
`sma_direction()` in `indicators.py` has a hard cutoff: if `len(df) < 200`, it returns "neutral" â€” even if 150 bars of clearly trending data are available. Fix this to gracefully degrade to shorter-period SMA comparisons when full 200-bar data isn't available.

## Acceptance Criteria
- [ ] `sma_direction()` with >= 200 bars uses SMA20/50/200 (unchanged behavior)
- [ ] `sma_direction()` with >= 50 bars but < 200 falls back to SMA20 vs SMA50 comparison
- [ ] `sma_direction()` with < 50 bars returns "neutral" (genuinely insufficient)
- [ ] Existing tests for `sma_direction()` updated to cover all three tiers
- [ ] New tests added with synthetic DataFrames at 50, 100, 150, 200, 250 bar lengths

## Technical Details
- **indicators.py** (lines 200-223, `sma_direction()`):
  - Replace `if len(df) < 200: return "neutral"` with tiered logic:
    ```python
    if len(df) < 50:
        return "neutral"
    close = df["Close"]
    sma20 = close.rolling(20).mean().iloc[-1]
    sma50 = close.rolling(50).mean().iloc[-1]
    if len(df) >= 200:
        sma200 = close.rolling(200).mean().iloc[-1]
        if any(pd.isna(v) for v in (sma20, sma50, sma200)):
            return "neutral"
        if sma20 > sma50 > sma200:
            return "bullish"
        elif sma20 < sma50 < sma200:
            return "bearish"
        return "neutral"
    else:
        # Fallback: SMA20 vs SMA50
        if any(pd.isna(v) for v in (sma20, sma50)):
            return "neutral"
        if sma20 > sma50:
            return "bullish"
        elif sma20 < sma50:
            return "bearish"
        return "neutral"
    ```
- Also update `MIN_ROWS_SMA = 200` constant to `MIN_ROWS_SMA = 50` at line 17

## Dependencies
- [ ] Task 42 (data fetch period) should be done first so both fixes are in place

## Effort Estimate
- Size: S
- Hours: 1-2
- Parallel: false (blocks Task 3)

## Definition of Done
- [ ] `sma_direction()` gracefully degrades across 3 tiers
- [ ] New unit tests cover all tiers with synthetic DataFrames
- [ ] All existing tests pass
