---
name: Rewrite AI tests for SDK-based implementation
status: open
created: 2026-02-13T14:33:53Z
updated: 2026-02-13T14:36:49Z
github: https://github.com/jobu711/option_alpha_v2/issues/82
depends_on: [79, 80, 81]
parallel: false
conflicts_with: []
---

# Task: Rewrite AI tests for SDK-based implementation

## Description

Rewrite `tests/test_ai.py` to test the new SDK-based AI module. Replace httpx exception mocks with SDK exception mocks. Update retry logic tests for the new 1+1 retry model. Preserve coverage of all existing functionality: fallbacks, context building, debate orchestration, time budgets, concurrency, and progress callbacks.

## Acceptance Criteria

- [ ] All client tests mock at `LLMClient.complete()` level (not at httpx transport)
- [ ] OllamaClient tests mock `ollama.AsyncClient.chat()` and `ollama.AsyncClient.list()`
- [ ] ClaudeClient tests mock `anthropic.AsyncAnthropic.messages.create()`
- [ ] Retry tests verify 1+1 behavior (not 5 retries)
- [ ] Fallback tests preserved: context-aware fallbacks using ticker_score
- [ ] Context builder tests preserved (context.py unchanged, tests should still pass)
- [ ] Debate orchestration tests: concurrency, phase timeout, deterministic ordering
- [ ] Time budget tests: equal 1/3 split per agent
- [ ] Progress callback tests preserved
- [ ] Health check tests use SDK mock calls
- [ ] `pytest tests/test_ai.py` passes with 0 failures

## Technical Details

### Test categories to cover

1. **Client tests**
   - OllamaClient.complete() — success, JSON parse, structured output
   - ClaudeClient.complete() — success, structured output via tool-use
   - Health checks — healthy, unhealthy, timeout
   - get_client() factory — ollama default, claude with key, missing key error

2. **Agent tests**
   - run_bull_agent — success, fallback on failure
   - run_bear_agent — success with bull input, fallback on failure
   - run_risk_agent — success with bull+bear input, fallback on failure
   - _call_with_retry — success first try, success on retry, failure after retry
   - Fallback functions — with ticker_score, without ticker_score

3. **Debate tests**
   - run_debate — full success, partial failure (agent timeout), full failure
   - run_debates — concurrency, phase timeout, progress callback, deterministic sort
   - Time budget — equal split, timeout propagation
   - _fallback_debate_result — context-aware fallback

4. **Context tests** — should pass unchanged (context.py not modified)

### Mocking strategy
```python
# Mock at complete() level for most tests
async def mock_complete(messages, response_model=None):
    if response_model is AgentResponse:
        return AgentResponse(role="bull", analysis="...", key_points=["..."], conviction=7)
    ...

# Mock SDK internals only for client-specific tests
with patch.object(ollama.AsyncClient, "chat", return_value=mock_response):
    ...
```

### Files affected
- `tests/test_ai.py` — full rewrite

## Dependencies

- [ ] Task 79, 80, 81 (all AI module files rewritten)

## Effort Estimate

- Size: L
- Hours: 5
- Parallel: false (needs implementation complete)

## Definition of Done

- [ ] test_ai.py rewritten
- [ ] All AI tests passing
- [ ] Coverage of clients, agents, debate, context preserved
- [ ] No httpx mocks in AI tests
