---
name: Tests for universe expansion
status: open
created: 2026-02-11T14:35:48Z
updated: 2026-02-11T14:41:55Z
github: https://github.com/jobu711/option_alpha_v2/issues/26
depends_on: [21, 24, 27, 28, 22]
parallel: true
conflicts_with: []
---

# Task: Tests for universe expansion

## Description

Update existing `test_universe.py` and add new test coverage for all universe expansion features: file-based data store, dynamic refresh, presets, sector filters, watchlists, and pipeline integration with dynamic universe. All tests use mocking — no live API calls.

## Acceptance Criteria

- [ ] `test_universe.py` updated for file-based universe loading
- [ ] Tests for `load_universe_data()`: loads JSON, returns typed metadata, handles missing file
- [ ] Tests for `get_full_universe()`: backward compat, returns sorted symbols
- [ ] Tests for `get_scan_universe()`: preset filtering, sector filtering, combined filters, extra tickers
- [ ] Tests for each preset: sp500 returns large-cap stocks, midcap returns mid-cap, etc.
- [ ] Tests for sector filtering: single sector, multiple sectors, empty = all
- [ ] Tests for `universe_refresh.py`: SEC EDGAR fetch mock, optionability validation mock, diff detection, fallback on failure
- [ ] Tests for `should_refresh()`: stale detection, fresh detection, missing meta file
- [ ] Tests for `watchlists.py`: CRUD operations, active watchlist, ticker validation mock, file persistence
- [ ] Tests for pipeline integration: orchestrator uses `get_scan_universe()`, respects settings
- [ ] All existing tests continue to pass (no regressions)
- [ ] Test coverage for new code > 90%

## Technical Details

**Files to modify:**
- `tests/test_universe.py` — Major rewrite for new data structures

**Files to create:**
- `tests/test_universe_refresh.py` — Tests for refresh module
- `tests/test_watchlists.py` — Tests for watchlist CRUD
- Update `tests/test_pipeline.py` (or create `tests/test_pipeline_universe.py`) — Pipeline integration tests

**Testing patterns (consistent with existing tests):**
```python
# Mock universe data file
@pytest.fixture
def sample_universe_data(tmp_path):
    data = [
        {"symbol": "AAPL", "name": "Apple", "sector": "Technology", "market_cap_tier": "large", "asset_type": "stock"},
        {"symbol": "SPY", "name": "SPDR S&P 500", "sector": "", "market_cap_tier": "", "asset_type": "etf"},
        ...
    ]
    path = tmp_path / "universe_data.json"
    path.write_text(json.dumps(data))
    return path

# Mock SEC EDGAR response
@pytest.fixture
def mock_edgar_response():
    return {"0": {"cik_str": 320193, "ticker": "AAPL", "title": "Apple Inc."}, ...}
```

**Key test scenarios:**
1. Universe loads from JSON file correctly
2. Missing JSON file returns sensible default or error
3. Presets filter by market_cap_tier and asset_type
4. Multiple presets combine via union
5. Sector filters intersect with presets
6. Refresh fetches, validates, and writes updated file
7. Refresh fallback on network failure
8. Watchlist CRUD persists to file
9. Active watchlist merges into scan universe
10. Orchestrator calls `get_scan_universe()` with correct params

## Dependencies

- [ ] Tasks 001-005 must be at least partially complete to test against
- [ ] Can write test skeletons early and fill in as implementation progresses

## Effort Estimate

- Size: M
- Hours: 8-10
- Parallel: true (can develop test skeletons early, fill in as features complete)

## Definition of Done

- [ ] All new test files created and passing
- [ ] Existing test suite passes with no regressions (`pytest tests/`)
- [ ] New code test coverage > 90%
- [ ] Tests use mocking exclusively (no live API calls)
- [ ] Tests follow existing patterns (fixtures, parametrize where appropriate)
