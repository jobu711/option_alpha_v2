---
name: Dynamic universe refresh
status: open
created: 2026-02-11T14:35:48Z
updated: 2026-02-11T14:41:55Z
github: https://github.com/jobu711/option_alpha_v2/issues/24
depends_on: [21]
parallel: true
conflicts_with: []
---

# Task: Dynamic universe refresh

## Description

Add a `universe_refresh.py` module that automatically refreshes the ticker universe weekly from SEC EDGAR + yfinance. The refresh mechanism fetches the latest US-listed companies, validates optionability, enriches with sector/market-cap metadata, and updates `universe_data.json` with a diff log. Auto-triggers on first scan after 7 days since last refresh, with manual trigger available. Falls back to existing data on failure.

## Acceptance Criteria

- [ ] `universe_refresh.py` module created in `src/option_alpha/data/`
- [ ] `refresh_universe()` async function fetches SEC EDGAR tickers, validates optionability, enriches metadata
- [ ] `universe_meta.json` stores refresh metadata: `{"last_refresh": ISO timestamp, "ticker_count": int, "added": int, "removed": int}`
- [ ] Diff logging: prints/logs tickers added and removed since last refresh
- [ ] Auto-trigger: `should_refresh()` returns True if last refresh > 7 days ago (configurable)
- [ ] Manual trigger: function callable from routes for settings UI
- [ ] Fallback: if refresh fails (network error, SEC down), keeps existing `universe_data.json` unchanged
- [ ] Retry: up to 3 attempts on refresh failure before falling back
- [ ] Refresh completes within 10 minutes for full validation cycle
- [ ] `universe_refresh_interval_days` setting added to `config.py`

## Technical Details

**Files to create:**
- `src/option_alpha/data/universe_refresh.py`

**Files to modify:**
- `src/option_alpha/config.py` — Add `universe_refresh_interval_days: int = 7`

**Refresh pipeline:**
1. Fetch `https://www.sec.gov/files/company_tickers.json` via httpx
2. Extract tickers, filter to common stock
3. Batch-validate optionability (reuse batching pattern from fetcher.py)
4. Enrich with sector + market-cap from yfinance `.info`
5. Diff against current `universe_data.json`
6. Write updated file + update `universe_meta.json`

**Integration point:**
- `orchestrator.py` Phase 1 calls `should_refresh()` before `get_full_universe()`
- If refresh needed, runs `refresh_universe()` first (adds ~5 min to first scan of the week)

## Dependencies

- [ ] Task 001 (universe data store) — must have `universe_data.json` schema and `load_universe_data()`
- [ ] httpx (already a project dependency)
- [ ] yfinance (already a project dependency)

## Effort Estimate

- Size: M
- Hours: 8-10
- Parallel: true (can develop alongside Tasks 3, 4 after Task 1 completes)

## Definition of Done

- [ ] `refresh_universe()` produces valid `universe_data.json` from SEC EDGAR + yfinance
- [ ] `universe_meta.json` tracks refresh history
- [ ] `should_refresh()` correctly detects stale universe (>7 days)
- [ ] Fallback works: existing data preserved on refresh failure
- [ ] Tests with mocked SEC EDGAR/yfinance responses pass
