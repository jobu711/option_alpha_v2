---
name: Pipeline integration with dynamic universe
status: open
created: 2026-02-11T14:35:48Z
updated: 2026-02-11T14:41:55Z
github: https://github.com/jobu711/option_alpha_v2/issues/22
depends_on: [21, 27]
parallel: false
conflicts_with: []
---

# Task: Pipeline integration with dynamic universe

## Description

Update the scan pipeline orchestrator to use the new dynamic universe system instead of the hardcoded `get_full_universe()`. The orchestrator's Phase 1 (Data Fetch) should call `get_scan_universe()` with the user's preset/sector/watchlist selections from settings, and optionally trigger a universe refresh if stale. This is a small, targeted change — only the universe source in `_phase_data_fetch` needs to change.

## Acceptance Criteria

- [ ] `_phase_data_fetch` in `orchestrator.py` calls `get_scan_universe()` instead of `get_full_universe()`
- [ ] Preset and sector selections read from `self.settings.universe_presets` and `self.settings.universe_sectors`
- [ ] Active watchlist tickers merged via `get_active_watchlist()`
- [ ] Optional: auto-refresh check via `should_refresh()` before fetching universe (if refresh module is ready)
- [ ] Scan progress reports the actual universe size (not hardcoded)
- [ ] `run_scan()` optionally accepts `universe_override: list[str]` for one-off custom scans (e.g., quick-add from dashboard)
- [ ] All downstream phases (scoring, catalysts, options, AI) work unchanged with the dynamic universe

## Technical Details

**Files to modify:**
- `src/option_alpha/pipeline/orchestrator.py` — Change `_phase_data_fetch` universe source

**Current code (line 208):**
```python
universe = get_full_universe()
```

**New code:**
```python
from option_alpha.data.universe import get_scan_universe
from option_alpha.data.watchlists import get_active_watchlist

# Get universe based on user's preset/sector/watchlist config
extra = get_active_watchlist()
universe = get_scan_universe(
    presets=self.settings.universe_presets,
    sectors=self.settings.universe_sectors,
    extra_tickers=extra,
)
```

**Optional refresh integration (if Task 002 is done):**
```python
from option_alpha.data.universe_refresh import should_refresh, refresh_universe

if should_refresh(settings=self.settings):
    await refresh_universe(settings=self.settings)
```

**`run_scan` signature update:**
```python
async def run_scan(
    self,
    on_progress: Optional[ProgressCallback] = None,
    universe_override: Optional[list[str]] = None,
) -> ScanResult:
```

## Dependencies

- [ ] Task 001 (universe data store) — `universe_data.json` and `load_universe_data()` must exist
- [ ] Task 003 (presets/filters) — `get_scan_universe()` must be implemented
- [ ] Task 004 (watchlists) — `get_active_watchlist()` should exist (can stub if not ready)
- [ ] Task 002 (refresh) — optional integration, can be added later

## Effort Estimate

- Size: S
- Hours: 2-3
- Parallel: false (depends on Tasks 1 and 3)

## Definition of Done

- [ ] Orchestrator uses `get_scan_universe()` for dynamic universe
- [ ] Preset/sector settings correctly filter the scan universe
- [ ] Watchlist tickers included in scan
- [ ] `universe_override` parameter works for one-off scans
- [ ] All existing pipeline tests pass
- [ ] Integration test: scan with preset returns expected ticker count
