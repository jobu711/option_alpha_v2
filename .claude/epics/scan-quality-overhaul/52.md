---
name: Enrich AI debate context with interpretive labels and risk params
status: open
created: 2026-02-12T11:13:23Z
updated: 2026-02-12T11:15:00Z
github: https://github.com/jobu711/option_alpha_v2/issues/52
depends_on: [51]
parallel: false
conflicts_with: [53]
---

# Task: Enrich AI debate context with interpretive labels and risk params

## Description
Expand `build_context()` in `ai/context.py` to produce richer ~2500-3000 token context. Add interpretive labels for all indicators, options flow summary, ATR-based risk parameters, and optional sector context. Target < 4000 tokens for small LLM compatibility.

## Acceptance Criteria
- [ ] Score breakdown table includes interpretive label column for all indicators
- [ ] Options flow section present when `OptionsRecommendation` provided (IV context, volume/OI)
- [ ] Risk parameters section with ATR-based stop distance and BB support/resistance
- [ ] Sector name in header when provided via new optional `sector` parameter
- [ ] Context stays under 4000 tokens (~16000 chars) for representative input
- [ ] All related tests pass

## Technical Details

### Files to modify
- `src/option_alpha/ai/context.py` — expand `build_context()`, add helpers
- `tests/test_ai.py` — tests for enriched context

### New helper: `_interpret_indicator(name: str, raw_value: float) -> str`
Returns concise interpretive label:
- `adx`: <20 "weak", 20-25 "developing", 25-50 "moderate", 50-75 "strong", >75 "extreme"
- `rsi`: <30 "oversold", 30-50 "bearish", 50-70 "bullish", >70 "overbought"
- `stoch_rsi`: <20 "oversold", >80 "overbought", else "neutral"
- `williams_r`: < -80 "oversold", > -20 "overbought", else "neutral"
- `roc`: >0 "positive", <0 "negative", 0 "flat"
- `relative_volume`: <0.5 "quiet", 0.5-0.8 "below avg", 0.8-1.2 "normal", 1.2-2 "elevated", >2 "surge"
- `bb_width`/`keltner_width`: <0.05 "tight squeeze", 0.05-0.1 "moderate", >0.1 "wide"
- `sma_alignment`: >80 "tight", 50-80 "moderate", <50 "wide spread"
- `supertrend`: 1 "bullish", -1 "bearish"
- `vwap_deviation`: >1 "above VWAP", <-1 "below VWAP", else "near VWAP"
- Others: return raw value formatted

### Updated score breakdown format
Add interpretation column to existing table:
```
Indicator         | Raw     | Pctl | Weight | Interpretation
------------------|---------|------|--------|---------------
adx               |   32.40 |   72 |   0.08 | moderate trend
rsi               |   58.30 |   61 |   0.08 | bullish momentum
```

### New section: OPTIONS FLOW
```
OPTIONS FLOW:
  Direction: CALL (bullish alignment)
  IV: 0.35 (moderate)
  Volume/OI: 245/1,230 (0.20 ratio — normal)
```
Derived from existing `OptionsRecommendation` fields.

### New section: RISK PARAMETERS
```
RISK PARAMETERS:
  ATR-based stop distance: 3.2% from entry
  Bollinger support zone: ~$178.50 (lower band approx)
  Bollinger resistance zone: ~$192.30 (upper band approx)
```
ATR% from breakdown. BB levels approximated from bb_width raw value and last_price.

### Updated signature
```python
def build_context(
    ticker_score: TickerScore,
    options_rec: Optional[OptionsRecommendation] = None,
    sector: Optional[str] = None,
) -> str:
```

### Pipeline integration
Update the orchestrator's call to `build_context()` to pass sector from universe ticker metadata if available. This is a minor change in `pipeline/orchestrator.py` or `ai/debate.py`.

## Dependencies
- [ ] Task 002 must be complete (new indicators in scoring breakdown)

## Effort Estimate
- Size: M
- Hours: 4-5
- Parallel: false — depends on Task 002

## Definition of Done
- [ ] build_context() produces enriched output with all new sections
- [ ] Interpretive labels correct for all indicator ranges
- [ ] Context under 4000 tokens verified
- [ ] Tests written and passing
- [ ] `pytest tests/test_ai.py` passes
