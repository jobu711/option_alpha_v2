---
name: Add update_scan_run to repository
status: open
created: 2026-02-11T18:41:29Z
updated: 2026-02-11T18:41:29Z
github: https://github.com/jobu711/option_alpha_v2/issues/38
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Add update_scan_run to repository

## Description
Add an `update_scan_run()` function to `persistence/repository.py` that updates an existing scan run row with post-debate fields. This supports the checkpoint pattern where the scan run is first saved with `PARTIAL` status during the persist phase, then updated to `COMPLETED` after the debate phase finishes.

## Acceptance Criteria
- [ ] New `update_scan_run(conn, scan_db_id, ...)` function in `repository.py`
- [ ] Can update: `status`, `debates_completed`, `duration_seconds`, `error_message`
- [ ] Only updates fields that are explicitly passed (no overwriting with None)
- [ ] Returns None (void) — simple update, no return value needed
- [ ] Calls `conn.commit()` after update (consistent with existing repo functions)

## Technical Details
**Files:**
- `src/option_alpha/persistence/repository.py` — Add function after `save_ai_theses()`

**Implementation:**
```python
def update_scan_run(
    conn: sqlite3.Connection,
    scan_db_id: int,
    *,
    status: ScanStatus | None = None,
    debates_completed: int | None = None,
    duration_seconds: float | None = None,
    error_message: str | None = None,
) -> None:
    """Update fields on an existing scan run row."""
    updates: list[str] = []
    params: list[Any] = []
    if status is not None:
        updates.append("status = ?")
        params.append(status.value)
    if debates_completed is not None:
        updates.append("debates_completed = ?")
        params.append(debates_completed)
    if duration_seconds is not None:
        updates.append("duration_seconds = ?")
        params.append(duration_seconds)
    if error_message is not None:
        updates.append("error_message = ?")
        params.append(error_message)
    if not updates:
        return
    params.append(scan_db_id)
    conn.execute(
        f"UPDATE scan_runs SET {', '.join(updates)} WHERE id = ?",
        params,
    )
    conn.commit()
```

**No schema changes needed** — all updated columns already exist in the `scan_runs` table.

## Dependencies
- [ ] None — this is independent of the AI/config changes

## Effort Estimate
- Size: XS
- Hours: 0.25
- Parallel: true (independent of #35-#37)

## Definition of Done
- [ ] Function implemented
- [ ] Existing tests still pass
