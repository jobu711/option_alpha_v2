---
name: Compress context builder
status: open
created: 2026-02-13T12:43:00Z
updated: 2026-02-13T12:46:59Z
github: https://github.com/jobu711/option_alpha_v2/issues/74
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Compress context builder

## Description

Reduce `build_context()` output from ~2500-3000 tokens to ~1500-2000 tokens. This is the single highest-impact change for Ollama performance — smaller prompts mean faster inference and fewer timeouts.

Changes:
1. Show only top 6 indicators by weight instead of all 12-14
2. Replace padded table format with compact key-value lines
3. Condense options flow and risk parameters into single-line summaries
4. Remove trailing "Based on the above data..." prompt (redundant with system prompt)

## Acceptance Criteria

- [ ] `build_context()` with full breakdown produces <2000 estimated tokens (test assertion)
- [ ] Only top 6 indicators by weight are shown in breakdown
- [ ] Breakdown uses compact format: `  rsi: 58.3 (bullish momentum) [pctl=55, w=0.10]`
- [ ] Padded table headers/separators removed
- [ ] Options flow section condensed to 2-3 lines max
- [ ] Risk parameters condensed to single line
- [ ] Trailing "Based on the above data..." prompt removed
- [ ] All essential data still present (symbol, score, direction, price, volume, top indicators, options, risk)
- [ ] Updated context tests pass with new format assertions

## Technical Details

### New Compact Breakdown Format

Replace:
```
  Indicator         | Raw     | Pctl | Weight | Interpretation
  ------------------|---------|------|--------|---------------
  bb_width          |    0.05 |   72 |   0.20 | tight squeeze
  rsi               |   58.30 |   55 |   0.10 | bullish momentum
```

With:
```
INDICATORS (top 6 by weight):
  catalyst_proximity: 0.85 (approaching) [pctl=85, w=0.25]
  bb_width: 0.05 (tight squeeze) [pctl=72, w=0.20]
  atr_percentile: 0.65 (N/A) [pctl=65, w=0.15]
  rsi: 58.3 (bullish momentum) [pctl=55, w=0.10]
  obv_trend: 1.2 (accumulating) [pctl=80, w=0.10]
  sma_alignment: 1.0 (tight alignment) [pctl=90, w=0.10]
```

### Condensed Options Flow

Replace multi-line section with:
```
OPTIONS FLOW: CALL (bullish), IV=28.5% (moderate), Vol/OI=3400/12500 (0.27)
```

### Condensed Risk Parameters

Replace multi-line section with:
```
RISK: ATR=3.2%, Stop-long=$174.24, Stop-short=$185.76
```

### Test Updates Required

Many tests in `TestContextBuilder` assert specific format strings:
- `test_includes_score_breakdown` — Update to check compact format
- `test_includes_interpretation_column` — Remove (no table column headers)
- `test_includes_options_flow_section` — Update format assertions
- `test_includes_risk_parameters_with_atr` — Update format assertions
- `test_context_reasonable_length` — Tighten token estimate bounds
- `test_empty_breakdown` — Update "No detailed breakdown" check

### Files Affected
- `src/option_alpha/ai/context.py` — Rewrite `_format_score_breakdown()`, `_format_options_flow()`, `_format_risk_params()`, modify `build_context()`
- `tests/test_ai.py` — Update `TestContextBuilder` assertions

## Dependencies
- [ ] None — context.py is independent of config and debate changes

## Effort Estimate
- Size: M
- Parallel: true
