---
name: Lighten health check and unify JSON hints
status: open
created: 2026-02-13T12:43:00Z
updated: 2026-02-13T12:46:59Z
github: https://github.com/jobu711/option_alpha_v2/issues/73
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Lighten health check and unify JSON hints

## Description

Two independent changes in `ai/clients.py`:

1. **Lighter Ollama health check**: Remove the expensive `/api/generate` call (which cold-loads the model and can take 10-30s). Instead, just check `/api/tags` and verify the configured model appears in the response. This saves 10-30s of startup time on modest hardware.

2. **Unify Claude JSON hints**: `ClaudeClient.complete()` currently dumps the full `model_json_schema()` (verbose, includes descriptions/properties/types). Switch to the compact `_build_example_hint()` approach already used by `OllamaClient`. This reduces prompt token count by ~200-400 tokens per request.

## Acceptance Criteria

- [ ] `OllamaClient.health_check()` only calls `GET /api/tags` — no `/api/generate` call
- [ ] Health check verifies the configured model name appears in the `/api/tags` response
- [ ] Health check still returns `False` for connection errors, timeouts, missing model
- [ ] `ClaudeClient.complete()` uses `_build_example_hint()` instead of `model_json_schema()`
- [ ] Claude structured output still parses correctly (existing tests pass)
- [ ] Update health check tests that assert `/api/generate` was called
- [ ] Update Claude structured output test to verify example hint (not schema) in prompt

## Technical Details

### Ollama Health Check Change

Current (expensive):
```python
# Step 1: GET /api/tags
# Step 2: POST /api/generate with prompt="Say OK"  <-- REMOVE THIS
```

New (lightweight):
```python
# Step 1: GET /api/tags
# Step 2: Check response JSON for configured model name
resp_data = resp.json()
models = [m.get("name", "") for m in resp_data.get("models", [])]
if self.model not in models and not any(self.model in m for m in models):
    logger.error("Model %s not found in Ollama", self.model)
    return False
```

### Claude JSON Hint Change

Current in `ClaudeClient.complete()`:
```python
schema = response_model.model_json_schema()
schema_hint = f"\n\nRespond ONLY with a JSON object matching this schema...\n{json.dumps(schema, indent=2)}"
```

New:
```python
example_hint = _build_example_hint(response_model)
# Append to last user message (same as OllamaClient already does)
```

### Files Affected
- `src/option_alpha/ai/clients.py` — Both health check and JSON hint changes
- `tests/test_ai.py` — Update `TestOllamaClientRequest` health check tests, `TestClaudeClientRequest` structured output test

## Dependencies
- [ ] None — independent of other tasks

## Effort Estimate
- Size: S
- Parallel: true
